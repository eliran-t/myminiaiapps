<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SunoSongsSistent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3a 50%, #0f0f23 100%);
            min-height: 100vh;
        }

        .editor-font {
            font-family: 'Roboto Mono', monospace;
            line-height: 1.6;
            font-size: 1em;
        }

        .jukebox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
            padding: 2rem 0;
        }

        .lyrics-section-bubble {
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: grab;
            border: 2px solid transparent;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .unsectioned-bubble {
            border-style: dashed;
            border-color: #F59E0B;
            background: rgba(245, 158, 11, 0.05);
        }

        .empty-bubble {
            border-style: dashed;
            border-color: #6B7280;
            background: rgba(107, 114, 128, 0.05);
        }

        .lyrics-section-bubble:active {
            cursor: grabbing;
        }

        .lyrics-section-bubble.dragging {
            opacity: 0.7;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            transform: rotate(2deg) scale(1.02);
        }

        .lyrics-section-bubble textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            resize: none;
            outline: none;
            overflow-y: hidden;
        }

        .fab {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 10px 25px rgba(168, 85, 247, 0.3));
        }

        .fab:hover {
            transform: scale(1.1) rotate(5deg);
            filter: drop-shadow(0 15px 35px rgba(168, 85, 247, 0.5));
        }

        .fab:hover .record-arm {
            transform: rotate(-35deg);
        }

        .fab:hover .plus-sign {
            transform: translate(35px, 20px);
        }

        .record-arm {
            transition: transform 0.3s ease;
            transform-origin: 80px 15px;
        }

        .plus-sign {
            transition: transform 0.3s ease;
        }

        .menu-dropdown {
            display: none;
            position: absolute;
            background: rgba(45, 55, 72, 0.95);
            backdrop-filter: blur(20px);
            min-width: 220px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 10;
            border-radius: 16px;
            border: 1px solid rgba(168, 85, 247, 0.2);
            right: 0;
            margin-top: 8px;
        }

        .menu-dropdown-item {
            padding: 14px 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 12px;
            margin: 4px;
        }

        .menu-dropdown-item:hover {
            background: rgba(168, 85, 247, 0.2);
            transform: translateX(4px);
        }

        .version-dropdown-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .version-notes {
            font-size: 0.85em;
            color: #a0aec0;
            white-space: normal;
        }

        .draft-version {
            color: #9CA3AF;
        }

        #song-title[contenteditable]:focus {
            outline: 2px dashed #a78bfa;
            border-radius: 8px;
            background: rgba(168, 85, 247, 0.1);
            padding: 4px 8px;
        }

        .switch-btn {
            padding: 8px 12px;
            border-radius: 12px;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .switch-btn.active {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
        }

        .spinning-record {
            animation: spin 4s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* New card hover effects */
        .song-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(51, 65, 85, 0.6));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(168, 85, 247, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
        }

        .song-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(168, 85, 247, 0.2);
            border-color: rgba(168, 85, 247, 0.3);
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.8));
        }

        /* Enhanced navigation */
        .nav-glass {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(168, 85, 247, 0.1);
        }

        /* Improved input styling */
        .glass-input {
            background: rgba(31, 41, 55, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(168, 85, 247, 0.2);
            transition: all 0.2s ease;
        }

        .glass-input:focus {
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
        }

        /* Improved button styling */
        .btn-primary {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(168, 85, 247, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #059669, #10b981);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
    </style>
</head>

<body class="text-white min-h-screen">

    <nav class="sticky top-0 z-20 nav-glass shadow-lg">
        <div class="container mx-auto flex justify-between items-center p-4">
            <div class="text-2xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                âœ¨ SunoSongsSistent
            </div>
            <div class="flex items-center gap-4">
                <div class="relative">
                    <button id="file-menu-btn" class="text-gray-400 hover:text-white transition-colors"
                        title="File Menu">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                        </svg>
                    </button>
                    <div id="file-menu-dropdown" class="menu-dropdown">
                        <label for="song-importer" class="menu-dropdown-item block">Import Song (.json)</label>
                        <input type="file" id="song-importer" class="hidden" accept=".json">
                        <button id="export-song-btn" class="menu-dropdown-item w-full text-left" disabled>Export Current
                            Song</button>
                    </div>
                </div>
                <div class="relative">
                    <button id="settings-btn" class="text-gray-400 hover:text-white transition-colors" title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div id="app" class="p-4 sm:p-6 lg:p-8">
        <div id="jukebox-view" class="relative">
            <div id="jukebox-grid" class="jukebox-grid"></div>
            <button id="create-new-song-fab"
                class="fab fixed bottom-8 left-8 w-20 h-20 rounded-full shadow-lg flex items-center justify-center bg-gradient-to-br from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 transition-all duration-300"
                title="Create New Song">
                <svg class="w-full h-full" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <!-- Spinning gradient background record -->
                    <g class="spinning-record" transform-origin="50 50">
                        <circle cx="50" cy="50" r="48" fill="#111827" stroke="#374151" stroke-width="2" />
                        <circle cx="50" cy="50" r="42" fill="none" stroke="url(#sheen)" stroke-width="1.5" />
                        <circle cx="50" cy="50" r="36" fill="none" stroke="#222222" stroke-width="1.5" />
                        <circle cx="50" cy="50" r="30" fill="none" stroke="#2a2a2a" stroke-width="1.5" />
                        <circle cx="50" cy="50" r="20" fill="url(#spinningLabelGradient)" />
                        <circle cx="50" cy="50" r="5" fill="#111827" />
                    </g>

                    <!-- Static record player arm (moved outside record, bigger) -->
                    <g class="record-arm">
                        <!-- Arm base/pivot -->
                        <circle cx="80" cy="15" r="4" fill="#4a5568" stroke="#718096" stroke-width="1.5" />
                        <!-- Arm shaft (bigger and longer) -->
                        <line x1="80" y1="15" x2="50" y2="50" stroke="#4a5568" stroke-width="4"
                            stroke-linecap="round" />
                        <!-- Arm head (where plus will be) -->
                        <circle cx="50" cy="50" r="10" fill="none" stroke="#4a5568" stroke-width="2" opacity="0.7" />
                    </g>

                    <!-- Static plus sign (centered and larger) -->
                    <g class="plus-sign">
                        <path d="M 50 35 V 65 M 35 50 H 65" stroke="white" stroke-width="5" stroke-linecap="round" />
                    </g>

                    <defs>
                        <linearGradient id="sheen" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#555;stop-opacity:1" />
                            <stop offset="25%" style="stop-color:#2a2a2a;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#555;stop-opacity:1" />
                            <stop offset="75%" style="stop-color:#2a2a2a;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#555;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="spinningLabelGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#c084fc;stop-opacity:1" />
                            <stop offset="25%" style="stop-color:#a855f7;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#7c3aed;stop-opacity:1" />
                            <stop offset="75%" style="stop-color:#6366f1;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#c084fc;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                </svg>
            </button>
        </div>

        <div id="song-ui-view" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <button id="back-to-jukebox" class="text-purple-400 hover:underline">&larr; Back to Jukebox</button>
                    <h1 id="song-title" class="text-4xl font-bold" contenteditable="true"></h1>
                </div>
                <div class="flex items-center gap-4">
                    <div id="auto-save-status" class="text-sm text-gray-400 transition-opacity duration-500 opacity-0">
                    </div>
                    <div class="relative inline-block text-left">
                        <button type="button" id="version-picker-btn"
                            class="inline-flex justify-center w-full rounded-xl border border-purple-500/30 shadow-lg px-6 py-3 glass-input text-sm font-medium text-white hover:border-purple-400/50 focus:outline-none transition-all duration-200">
                            Version: <span id="version-display"
                                class="ml-2 font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent"></span>
                            <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="version-dropdown" class="menu-dropdown version-dropdown-content"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-8">
                <!-- Left Half -->
                <div class="relative">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-purple-300">Lyrics</h2>
                        <div class="glass-input p-1 rounded-xl text-sm flex items-center border border-purple-500/20">
                            <button id="bubbles-view-btn" class="switch-btn active" title="Bubble View">
                                <i class="fas fa-wand-magic-sparkles text-base"></i>
                            </button>
                            <button id="text-view-btn" class="switch-btn" title="Text View">
                                <span class="font-mono font-bold text-sm">Aa</span>
                            </button>
                        </div>
                    </div>
                    <div id="lyrics-editor-container"
                        class="glass-input p-6 rounded-xl h-[60vh] overflow-y-auto border-0"></div>
                    <textarea id="plain-text-editor"
                        class="glass-input p-6 rounded-xl h-[60vh] w-full editor-font text-white hidden resize-none outline-none border-0"
                        placeholder="Write your lyrics here..."></textarea>
                    <div
                        class="absolute bottom-6 right-6 flex items-center gap-3 bg-black/20 backdrop-blur-xl border border-white/10 rounded-2xl p-2 shadow-2xl">
                        <span class="text-sm text-gray-300 pl-4 pr-2">Save as...</span>
                        <button id="create-version-btn"
                            class="fab btn-secondary text-white font-bold py-3 px-6 rounded-xl">âœ¨ Version</button>
                        <button id="save-draft-btn" class="fab btn-primary text-white font-bold py-3 px-6 rounded-xl">ðŸ’¾
                            Draft</button>
                    </div>
                </div>

                <!-- Right Half -->
                <div>
                    <div class="mb-6">
                        <h2 class="text-2xl font-semibold mb-4 text-purple-300">Style</h2>
                        <div class="glass-input p-4 rounded-xl"><textarea id="style-textarea"
                                class="w-full h-24 bg-transparent text-gray-200 resize-none outline-none border-0"
                                placeholder="Describe the musical style..."></textarea></div>
                    </div>
                    <div class="mb-6">
                        <h2 class="text-2xl font-semibold mb-4 text-purple-300">Links</h2>
                        <div class="glass-input p-4 rounded-xl">
                            <div id="links-list"></div>
                            <div class="flex mt-2"><input type="text" id="new-link-input" placeholder="Add a new link"
                                    class="flex-grow glass-input rounded-l-xl p-3 outline-none border-0"><button
                                    id="add-link-button"
                                    class="btn-primary text-white font-bold py-3 px-6 rounded-r-xl border-0">Add</button>
                            </div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <h2 class="text-2xl font-semibold mb-4 text-purple-300">Notes</h2>
                        <div class="glass-input p-4 rounded-xl"><textarea id="notes-textarea"
                                class="w-full h-24 bg-transparent text-gray-200 resize-none outline-none border-0"
                                placeholder="Add your notes here..."></textarea></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DB HELPER ---
        const DB_NAME = 'SunoSongsDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'songs';
        let db;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject("Error opening DB");
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    db.createObjectStore(STORE_NAME, { keyPath: 'songKey' });
                };
            });
        }

        function saveSongToDB(songData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(songData);
                request.onsuccess = () => resolve();
                request.onerror = () => reject("Error saving song");
            });
        }

        function deleteSongFromDB(songKey) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(songKey);
                request.onsuccess = () => resolve();
                request.onerror = () => reject("Error deleting song");
            });
        }

        function getAllSongsFromDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject("Error fetching songs");
            });
        }

        // --- DOM Elements ---
        const jukeboxView = document.getElementById('jukebox-view');
        const songUiView = document.getElementById('song-ui-view');
        const backToJukeboxBtn = document.getElementById('back-to-jukebox');
        const songImporter = document.getElementById('song-importer');
        const jukeboxGrid = document.getElementById('jukebox-grid');
        const createNewSongFab = document.getElementById('create-new-song-fab');
        const songTitle = document.getElementById('song-title');
        const versionPickerBtn = document.getElementById('version-picker-btn');
        const versionDisplay = document.getElementById('version-display');
        const versionDropdown = document.getElementById('version-dropdown');
        const lyricsEditorContainer = document.getElementById('lyrics-editor-container');
        const plainTextEditor = document.getElementById('plain-text-editor');
        const bubblesViewBtn = document.getElementById('bubbles-view-btn');
        const textViewBtn = document.getElementById('text-view-btn');
        const styleTextarea = document.getElementById('style-textarea');
        const notesTextarea = document.getElementById('notes-textarea');
        const linksList = document.getElementById('links-list');
        const newLinkInput = document.getElementById('new-link-input');
        const addLinkButton = document.getElementById('add-link-button');
        const saveDraftBtn = document.getElementById('save-draft-btn');
        const createVersionBtn = document.getElementById('create-version-btn');
        const autoSaveStatus = document.getElementById('auto-save-status');
        const fileMenuBtn = document.getElementById('file-menu-btn');
        const fileMenuDropdown = document.getElementById('file-menu-dropdown');
        const exportSongBtn = document.getElementById('export-song-btn');

        // --- State ---
        let currentSongKey = null;
        let allSongs = {};
        const sectionColors = {};
        let autoSaveInterval = null;
        let currentEditorMode = 'bubbles';
        let isDirty = false;
        const AUTO_SAVE_TIME = 60000;

        // --- Sample Data ---
        const sampleSong = {
            songKey: "chinese_roomba",
            songName: "Chinese Roomba",
            versions: [{
                version: "00000",
                creationDate: new Date().toISOString(),
                lyrics: [
                    `[Intro]\n"Opa! Gimme the microphone"`,
                    `This is a section without a tag.\nIt should be colorless.`,
                    `[Verse]\nBack then, you'd meet at the store,\nSame town, street, building, or next door.`
                ],
                style: "A fusion of Arabic ballad and Electro-Funk.",
                links: ["https://suno.com/song/example1"],
                notes: "Initial version created from scratch."
            }]
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            await openDB();
            const songsFromDB = await getAllSongsFromDB();
            if (songsFromDB.length === 0) {
                allSongs[sampleSong.songKey] = sampleSong;
                await saveSongToDB(sampleSong);
            } else {
                songsFromDB.forEach(song => {
                    allSongs[song.songKey] = song;
                });
            }
            init();
        });

        function init() {
            renderJukebox();
            backToJukeboxBtn.addEventListener('click', () => {
                clearInterval(autoSaveInterval);
                showJukeboxView();
            });
            songImporter.addEventListener('change', handleFileImport);
            createNewSongFab.addEventListener('click', createNewSong);
            saveDraftBtn.addEventListener('click', () => saveDraft(true));
            createVersionBtn.addEventListener('click', createVersion);
            versionPickerBtn.addEventListener('click', () => {
                versionDropdown.style.display = versionDropdown.style.display === 'block' ? 'none' : 'block';
            });
            addLinkButton.addEventListener('click', addLink);
            fileMenuBtn.addEventListener('click', () => {
                fileMenuDropdown.style.display = fileMenuDropdown.style.display === 'block' ? 'none' : 'block';
            });
            exportSongBtn.addEventListener('click', exportCurrentSong);
            songTitle.addEventListener('blur', renameSong);
            bubblesViewBtn.addEventListener('click', () => switchToBubbleView());
            textViewBtn.addEventListener('click', () => switchToTextView());

            [styleTextarea, notesTextarea, newLinkInput, plainTextEditor].forEach(el => el.addEventListener('input', () => isDirty = true));

            // Auto-resize plain text editor
            plainTextEditor.addEventListener('input', (e) => {
                e.target.style.height = 'auto';
                e.target.style.height = e.target.scrollHeight + 'px';
            });

            lyricsEditorContainer.addEventListener('dragover', e => {
                e.preventDefault();
                const draggingElement = document.querySelector('.dragging');
                if (!draggingElement) return;
                const afterElement = getDragAfterElement(lyricsEditorContainer, e.clientY);
                lyricsEditorContainer.insertBefore(draggingElement, afterElement);
            });

            window.addEventListener('click', (event) => {
                if (!versionPickerBtn.contains(event.target) && !versionDropdown.contains(event.target)) {
                    versionDropdown.style.display = 'none';
                }
                if (!fileMenuBtn.contains(event.target) && !fileMenuDropdown.contains(event.target)) {
                    fileMenuDropdown.style.display = 'none';
                }
            });
        }

        // --- View Management ---
        function showJukeboxView() {
            exportSongBtn.disabled = true;
            gsap.to(songUiView, {
                opacity: 0, duration: 0.3, onComplete: () => {
                    songUiView.classList.add('hidden');
                    jukeboxView.classList.remove('hidden');
                    gsap.fromTo(jukeboxView, { opacity: 0 }, { opacity: 1, duration: 0.3 });
                    renderJukebox();
                }
            });
        }
        function showSongUiView(onCompleteCallback) {
            exportSongBtn.disabled = false;
            gsap.to(jukeboxView, {
                opacity: 0, duration: 0.3, onComplete: () => {
                    jukeboxView.classList.add('hidden');
                    songUiView.classList.remove('hidden');
                    gsap.fromTo(songUiView, { opacity: 0 }, { opacity: 1, duration: 0.3, onComplete: onCompleteCallback });
                }
            });
        }

        // --- Jukebox Logic ---
        function renderJukebox() {
            jukeboxGrid.innerHTML = '';
            Object.values(allSongs).forEach(song => {
                const latestVersion = song.versions[song.versions.length - 1];
                const card = document.createElement('div');
                card.className = "song-card p-6 rounded-xl cursor-pointer transition-all duration-300";

                const displayVersion = formatVersionString(latestVersion.version);
                const lastUpdated = new Date(latestVersion.creationDate).toLocaleString([], {
                    year: 'numeric', month: 'numeric', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', hour12: false
                });

                card.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <h2 class="text-xl font-bold text-white flex-1">${song.songName}</h2>
                        <span class="text-sm bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-1 rounded-full font-medium">${displayVersion}</span>
                    </div>
                    <p class="text-xs text-gray-400 flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                        </svg>
                        ${lastUpdated}
                    </p>
                    <div class="mt-4 h-1 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full opacity-60"></div>
                `;
                card.addEventListener('click', () => loadSong(song.songKey, latestVersion.version));
                jukeboxGrid.appendChild(card);
            });
        }

        // --- Song Loading & Creation ---
        async function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const songData = JSON.parse(await file.text());
            if (songData && songData.songKey && songData.versions) {
                allSongs[songData.songKey] = songData;
                await saveSongToDB(songData);
                renderJukebox();
            }
            event.target.value = null;
        }

        function loadSong(songKey, versionString) {
            clearInterval(autoSaveInterval);
            isDirty = false;
            currentSongKey = songKey;
            const song = allSongs[currentSongKey];
            const version = song.versions.find(v => v.version === versionString);

            songTitle.textContent = song.songName;
            styleTextarea.value = version.style || '';
            notesTextarea.value = version.notes || '';

            lyricsEditorContainer.innerHTML = '';

            populateVersionPicker();
            renderLinks(version.links || []);

            showSongUiView(() => {
                switchToBubbleView(version.lyrics);
                autoSaveInterval = setInterval(saveDraft, AUTO_SAVE_TIME);
            });
        }

        async function createNewSong() {
            let untitledCount = 1;
            let newSongKey;
            let newSongName;
            do {
                newSongName = `Untitled Song ${untitledCount}`;
                newSongKey = newSongName.toLowerCase().replace(/\s+/g, '_');
                untitledCount++;
            } while (allSongs[newSongKey]);

            const newSongData = {
                songKey: newSongKey,
                songName: newSongName,
                versions: [{
                    version: `00000`,
                    creationDate: new Date().toISOString(),
                    lyrics: [`[Verse]\nYour lyrics here...`, ''],
                    style: "", links: [], notes: "First version."
                }]
            };
            allSongs[newSongKey] = newSongData;
            await saveSongToDB(newSongData);
            loadSong(newSongKey, '00000');
        }

        async function renameSong() {
            const newName = songTitle.textContent.trim();
            if (!newName || newName === allSongs[currentSongKey].songName) {
                songTitle.textContent = allSongs[currentSongKey].songName;
                return;
            }

            const newKey = newName.toLowerCase().replace(/\s+/g, '_');
            if (allSongs[newKey]) {
                alert("A song with this name already exists. Please choose a different name.");
                songTitle.textContent = allSongs[currentSongKey].songName;
                return;
            }

            const oldKey = currentSongKey;
            const songData = allSongs[oldKey];

            songData.songKey = newKey;
            songData.songName = newName;
            allSongs[newKey] = songData;
            delete allSongs[oldKey];
            currentSongKey = newKey;

            await saveSongToDB(songData);
            await deleteSongFromDB(oldKey);

            showSaveStatus("Song renamed!");
        }

        // --- LYRICS EDITOR ---
        function switchToBubbleView(lyrics) {
            currentEditorMode = 'bubbles';
            bubblesViewBtn.classList.add('active');
            textViewBtn.classList.remove('active');
            lyricsEditorContainer.classList.remove('hidden');
            plainTextEditor.classList.add('hidden');

            // Convert from text view if switching from text mode
            let lyricsArray;
            if (lyrics) {
                // Loading from saved data
                lyricsArray = lyrics;
            } else if (plainTextEditor.value.trim()) {
                // Convert text editor content to bubbles
                lyricsArray = plainTextEditor.value.split(/\n\s*\n/).filter(section => section.trim());
            } else {
                // Get current bubble content (fallback)
                const sections = [];
                const textareas = lyricsEditorContainer.querySelectorAll('.lyrics-section-bubble textarea');
                textareas.forEach(textarea => {
                    sections.push(textarea.value);
                });
                lyricsArray = sections;
            }

            renderLyricsBubbles(lyricsArray);
        }

        function switchToTextView() {
            currentEditorMode = 'text';
            textViewBtn.classList.add('active');
            bubblesViewBtn.classList.remove('active');
            plainTextEditor.classList.remove('hidden');
            lyricsEditorContainer.classList.add('hidden');

            // Convert from bubble view to text - directly get textarea values
            const sections = [];
            const textareas = lyricsEditorContainer.querySelectorAll('.lyrics-section-bubble textarea');
            textareas.forEach(textarea => {
                const value = textarea.value.trim();
                if (value) {
                    sections.push(value);
                }
            });

            // Join sections with double newlines
            const textContent = sections.join('\n\n');
            plainTextEditor.value = textContent;

            // Auto-resize the textarea
            plainTextEditor.style.height = 'auto';
            plainTextEditor.style.height = plainTextEditor.scrollHeight + 'px';
        }

        function createBubbleElement(sectionText) {
            const bubble = document.createElement('div');
            bubble.draggable = true;
            bubble.className = 'lyrics-section-bubble';

            const textarea = document.createElement('textarea');
            textarea.value = sectionText;
            textarea.className = 'editor-font';

            bubble.appendChild(textarea);
            updateBubbleStyle(bubble);

            bubble.addEventListener('dragstart', () => bubble.classList.add('dragging'));
            bubble.addEventListener('dragend', () => bubble.classList.remove('dragging'));

            textarea.addEventListener('input', (e) => {
                isDirty = true;
                autoResizeTextarea(e);
                maybeAddNewBubble(e);
                updateBubbleStyle(bubble);
            });
            textarea.addEventListener('keydown', handleTabText);

            return bubble;
        }

        function updateBubbleStyle(bubble) {
            const textarea = bubble.querySelector('textarea');
            if (!textarea) return;
            const text = textarea.value;
            const firstLine = text.split('\n')[0].trim();

            bubble.classList.remove('unsectioned-bubble', 'empty-bubble');

            if (text.trim() === '') {
                bubble.classList.add('empty-bubble');
                bubble.style.backgroundColor = 'transparent';
            } else if (firstLine.startsWith('[') && firstLine.endsWith(']')) {
                const sectionId = firstLine.substring(1, firstLine.length - 1).split(':')[0].trim();
                bubble.style.backgroundColor = getSectionColor(sectionId);
            } else {
                bubble.classList.add('unsectioned-bubble');
                bubble.style.backgroundColor = 'transparent';
            }
        }

        function renderLyricsBubbles(lyricsArray) {
            lyricsEditorContainer.innerHTML = '';

            if (typeof lyricsArray === 'string') {
                lyricsArray = lyricsArray.split(/\n\s*\n/);
            }

            lyricsArray.forEach(sectionText => {
                lyricsEditorContainer.appendChild(createBubbleElement(sectionText));
            });

            const lastBubble = lyricsEditorContainer.lastElementChild;
            if (!lastBubble || lastBubble.querySelector('textarea').value.trim() !== '') {
                lyricsEditorContainer.appendChild(createBubbleElement(''));
            }

            lyricsEditorContainer.querySelectorAll('textarea').forEach(textarea => {
                autoResizeTextarea({ target: textarea });
            });
        }

        function getLyricsAsArray() {
            if (currentEditorMode === 'bubbles') {
                const sections = [];
                const textareas = lyricsEditorContainer.querySelectorAll('.lyrics-section-bubble textarea');
                textareas.forEach(textarea => {
                    sections.push(textarea.value);
                });
                // Remove empty trailing sections
                while (sections.length > 0 && sections[sections.length - 1].trim() === '') {
                    sections.pop();
                }
                return sections;
            } else {
                return plainTextEditor.value.split(/\n\s*\n/);
            }
        }

        function autoResizeTextarea(event) {
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function maybeAddNewBubble(event) {
            const textarea = event.target;
            const bubble = textarea.parentElement;
            if (bubble === lyricsEditorContainer.lastElementChild && textarea.value.trim() !== '') {
                lyricsEditorContainer.appendChild(createBubbleElement(''));
            }
        }

        function handleTabText(event) {
            if (event.key === 'Tab') {
                event.preventDefault();
                const textareas = Array.from(lyricsEditorContainer.querySelectorAll('textarea'));
                const currentIndex = textareas.indexOf(event.target);
                const nextIndex = (currentIndex + 1) % textareas.length;
                textareas[nextIndex].focus();
            }
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.lyrics-section-bubble:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function getSectionColor(sectionId) {
            const baseColors = ['#4A235A', '#154360', '#145A32', '#6E2C00', '#5B2C6F', '#0E6251', '#78281F', '#424949'];
            let hash = 0;
            for (let i = 0; i < sectionId.length; i++) hash = sectionId.charCodeAt(i) + ((hash << 5) - hash);
            return baseColors[Math.abs(hash % baseColors.length)];
        }

        // --- Versioning and Saving ---
        async function saveDraft(isManual = false) {
            if (!isDirty && !isManual) return; // Don't auto-save if no changes

            const song = allSongs[currentSongKey];
            const latestVersion = song.versions[song.versions.length - 1];

            const [mainVersion, draftVersion] = latestVersion.version.split('.');
            const nextDraftNum = draftVersion ? parseInt(draftVersion) + 1 : 1;
            const newVersionString = `${mainVersion}.${nextDraftNum}`;

            const newDraft = {
                version: newVersionString,
                creationDate: new Date().toISOString(),
                lyrics: getLyricsAsArray(),
                style: styleTextarea.value,
                links: allSongs[currentSongKey].versions[allSongs[currentSongKey].versions.length - 1].links || [],
                notes: "Auto-saved draft."
            };

            song.versions.push(newDraft);
            await saveSongToDB(song);
            isDirty = false;

            if (isManual) {
                showSaveStatus("Draft saved!");
            } else {
                showSaveStatus(`Auto-saved at ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`);
            }

            loadSong(currentSongKey, newVersionString);
        }

        async function createVersion() {
            clearInterval(autoSaveInterval);
            const song = allSongs[currentSongKey];
            const latestVersion = song.versions[song.versions.length - 1];
            const mainVersion = parseInt(latestVersion.version.split('.')[0]);
            const newVersionNum = (mainVersion + 1).toString().padStart(5, '0');

            const newVersion = {
                version: newVersionNum,
                creationDate: new Date().toISOString(),
                lyrics: getLyricsAsArray(),
                style: styleTextarea.value,
                links: latestVersion.links || [],
                notes: prompt("Enter notes for this new version:", `Changes from v${mainVersion}`) || "New version."
            };

            song.versions.push(newVersion);
            await saveSongToDB(song);
            isDirty = false;
            showSaveStatus(`Version ${newVersionNum} created!`);
            loadSong(currentSongKey, newVersionNum);
        }

        function showSaveStatus(message) {
            autoSaveStatus.textContent = message;
            gsap.to(autoSaveStatus, {
                opacity: 1, duration: 0.5, onComplete: () => {
                    gsap.to(autoSaveStatus, { opacity: 0, duration: 0.5, delay: 2 });
                }
            });
        }

        function formatVersionString(version) {
            if (version.includes('.')) {
                const parts = version.split('.');
                return `v${parseInt(parts[0])}.${parts[1]}`;
            } else {
                return `v${parseInt(version)}`;
            }
        }

        function populateVersionPicker() {
            const song = allSongs[currentSongKey];
            const latestVersion = song.versions[song.versions.length - 1];
            versionDisplay.textContent = formatVersionString(latestVersion.version);
            versionDropdown.innerHTML = '';

            song.versions.slice().reverse().forEach(v => {
                const item = document.createElement('div');
                item.style.cursor = 'pointer';
                const date = new Date(v.creationDate || Date.now()).toLocaleString([], {
                    year: 'numeric', month: 'numeric', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', hour12: false
                });
                let versionClass = v.version.includes('.') ? 'draft-version' : 'font-bold';

                item.innerHTML = `<p class="${versionClass} menu-dropdown-item">Version ${v.version}</p><p class="version-notes">${v.notes}</p><p class="text-xs text-gray-500 mt-1">${date}</p>`;
                item.onclick = () => {
                    versionDropdown.style.display = 'none';
                    if (v.version !== latestVersion.version) {
                        loadSong(currentSongKey, v.version);
                    }
                };
                versionDropdown.appendChild(item);
            });
        }

        function exportCurrentSong() {
            if (!currentSongKey) return;
            const songData = allSongs[currentSongKey];
            const fileName = `${songData.songKey}.json`;
            const fileContent = JSON.stringify(songData, null, 2);

            const a = document.createElement("a");
            const file = new Blob([fileContent], { type: 'application/json' });
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        // --- Other Helpers ---
        function renderLinks(links) {
            linksList.innerHTML = '';
            if (!links || links.length === 0) {
                linksList.innerHTML = `<p class="text-gray-500">No links added.</p>`;
                return;
            }
            links.forEach((link, index) => {
                const linkEl = document.createElement('div');
                linkEl.className = 'flex justify-between items-center glass-input p-3 rounded-xl mb-3 border border-purple-500/20 hover:border-purple-400/40 transition-all duration-200';
                linkEl.innerHTML = `<a href="${link}" target="_blank" class="text-purple-400 hover:text-purple-300 underline truncate transition-colors duration-200">${link}</a><button data-index="${index}" class="remove-link-btn text-red-400 hover:text-red-300 font-bold text-xl transition-colors duration-200">&times;</button>`;
                linksList.appendChild(linkEl);
            });
            document.querySelectorAll('.remove-link-btn').forEach(btn => btn.addEventListener('click', (e) => removeLink(e.target.dataset.index)));
        }
        function addLink() {
            const newLink = newLinkInput.value.trim();
            if (newLink) {
                isDirty = true;
                const song = allSongs[currentSongKey];
                const latestVersion = song.versions[song.versions.length - 1];
                if (!latestVersion.links) latestVersion.links = [];
                latestVersion.links.push(newLink);
                renderLinks(latestVersion.links);
                newLinkInput.value = ''; // Clear the input field
            }
        }
        function removeLink(index) {
            isDirty = true;
            const song = allSongs[currentSongKey];
            const latestVersion = song.versions[song.versions.length - 1];
            latestVersion.links.splice(index, 1);
            renderLinks(latestVersion.links);
        }
    </script>
</body>

</html>