<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SunoSongsSistent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3a 50%, #0f0f23 100%);
            min-height: 100vh;
        }

        .editor-font {
            font-family: 'Roboto Mono', monospace;
            line-height: 1.6;
            font-size: 1em;
        }

        .jukebox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 3rem;
            padding: 3rem 0;
            justify-items: center;
        }

        .lyrics-section-bubble {
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: grab;
            border: 2px solid transparent;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .unsectioned-bubble {
            border-style: dashed;
            border-color: #F59E0B;
            background: rgba(245, 158, 11, 0.05);
        }

        .empty-bubble {
            border-style: dashed;
            border-color: #6B7280;
            background: rgba(107, 114, 128, 0.05);
        }

        .lyrics-section-bubble:active {
            cursor: grabbing;
        }

        .lyrics-section-bubble.dragging {
            opacity: 0.7;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            transform: rotate(2deg) scale(1.02);
        }

        .lyrics-section-bubble textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            resize: none;
            outline: none;
            overflow-y: hidden;
        }

        .fab {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 10px 25px rgba(168, 85, 247, 0.3));
        }

        .fab:hover {
            transform: scale(1.1) rotate(5deg);
            filter: drop-shadow(0 15px 35px rgba(168, 85, 247, 0.5));
        }

        .fab:hover .record-arm {
            transform: rotate(-35deg);
        }

        .fab:hover .plus-sign {
            transform: translate(35px, 20px);
        }

        .record-arm {
            transition: transform 0.3s ease;
            transform-origin: 80px 15px;
        }

        .plus-sign {
            transition: transform 0.3s ease;
        }

        .menu-dropdown {
            display: none;
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(24px);
            min-width: 280px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(168, 85, 247, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            z-index: 10;
            border-radius: 20px;
            border: 1px solid rgba(168, 85, 247, 0.2);
            right: 0;
            margin-top: 12px;
            padding: 8px;
            animation: dropdownSlideIn 0.2s ease-out forwards;
            transform-origin: top right;
        }

        @keyframes dropdownSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .menu-dropdown-item {
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 16px;
            margin: 2px 0;
            color: #e2e8f0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }

        .menu-dropdown-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, rgba(168, 85, 247, 0.2), rgba(168, 85, 247, 0.1));
            transition: width 0.3s ease;
            border-radius: 16px;
        }

        .menu-dropdown-item:hover {
            background: rgba(168, 85, 247, 0.15);
            transform: translateX(6px);
            color: #f1f5f9;
            box-shadow: 0 4px 20px rgba(168, 85, 247, 0.2);
        }

        .menu-dropdown-item:hover::before {
            width: 100%;
        }

        .menu-dropdown-item:active {
            transform: translateX(6px) scale(0.98);
        }

        .version-dropdown-content {
            max-height: 500px;
            overflow-y: auto;
            min-width: 380px;
            width: 380px;
            scrollbar-width: thin;
            scrollbar-color: rgba(168, 85, 247, 0.3) transparent;
        }

        .version-dropdown-content::-webkit-scrollbar {
            width: 6px;
        }

        .version-dropdown-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .version-dropdown-content::-webkit-scrollbar-thumb {
            background: rgba(168, 85, 247, 0.3);
            border-radius: 3px;
        }

        .version-dropdown-content::-webkit-scrollbar-thumb:hover {
            background: rgba(168, 85, 247, 0.5);
        }

        .version-item {
            border: none;
            background: rgba(30, 41, 59, 0.4);
            margin: 6px 8px;
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            position: relative;
        }

        .version-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(to bottom, #8B5CF6, #A855F7);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .version-item:hover {
            background: rgba(168, 85, 247, 0.1);
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(168, 85, 247, 0.15),
                0 0 0 1px rgba(168, 85, 247, 0.1);
        }

        .version-item:hover::before {
            opacity: 1;
        }

        .version-item .version-select {
            padding: 18px 20px;
        }

        .draft-version {
            color: #94a3b8 !important;
            font-style: italic;
        }

        .compare-btn {
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.3);
            transition: all 0.2s ease;
        }

        .compare-btn:hover {
            background: rgba(168, 85, 247, 0.2);
            border-color: rgba(168, 85, 247, 0.5);
            transform: scale(1.05);
        }

        .compare-btn:active {
            transform: scale(0.95);
        }

        /* Scrollbar styling for comparison modal */
        .scrollbar-thin::-webkit-scrollbar {
            width: 4px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 2px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(168, 85, 247, 0.4);
            border-radius: 2px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: rgba(168, 85, 247, 0.6);
        }

        /* Enhanced button animations */
        .btn-enhanced {
            position: relative;
            overflow: hidden;
            transform: translateZ(0);
        }

        .btn-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .btn-enhanced:hover::before {
            left: 100%;
        }

        /* Bubble selection styles */
        /* Bubble container layout */
        .bubble-container {
            display: flex;
            margin-bottom: 16px;
            position: relative;
        }

        .lyrics-section-bubble {
            flex: 1;
            position: relative;
            padding-left: 32px; /* Make room for checkbox and drag zone */
        }

        .bubble-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid #6B7280;
            border-radius: 3px;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bubble-checkbox:hover {
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.1);
        }

        .bubble-checkbox.checked {
            background: #8B5CF6;
            border-color: #8B5CF6;
        }

        .bubble-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        .drag-handle {
            width: 20px;
            position: absolute;
            top: 32px; /* Start right under the checkbox */
            left: 8px;
            bottom: 8px; /* Extend to bottom of bubble */
            background: rgba(107, 114, 128, 0.2);
            border-radius: 4px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            border: 1px solid rgba(107, 114, 128, 0.3);
            z-index: 5;
        }

        .drag-handle:hover {
            background: rgba(107, 114, 128, 0.4);
            border-color: #8B5CF6;
        }

        .drag-handle:active {
            cursor: grabbing;
            background: rgba(139, 92, 246, 0.3);
        }

        .drag-handle::before {
            content: '⋮⋮';
            color: #9CA3AF;
            font-size: 12px;
            line-height: 1;
            letter-spacing: -2px;
            writing-mode: vertical-lr;
            text-orientation: sideways;
        }

        .lyrics-section-bubble.selected {
            box-shadow: 
                0 0 0 2px rgba(168, 85, 247, 0.6),
                0 4px 20px rgba(168, 85, 247, 0.3);
            transform: scale(1.01);
        }

        .bubble-controls {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 10;
        }

        .lyrics-section-bubble:hover .bubble-controls {
            opacity: 1;
        }

        .bubble-control-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .bubble-control-btn:hover {
            transform: scale(1.1);
        }

        .bubble-copy-btn {
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
        }

        .bubble-copy-btn:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .bubble-delete-btn {
            background: linear-gradient(45deg, #EF4444, #DC2626);
            color: white;
        }

        .bubble-delete-btn:hover {
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        /* Multi-select indicator */
        .bubble-selection-count {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(168, 85, 247, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .bubble-selection-count.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }

        .version-notes {
            font-size: 0.85em;
            color: #a0aec0;
            white-space: normal;
        }

        .draft-version {
            color: #9CA3AF;
        }

        #song-title[contenteditable]:focus {
            outline: 2px dashed #a78bfa;
            border-radius: 8px;
            background: rgba(168, 85, 247, 0.1);
            padding: 4px 8px;
        }

        .switch-btn {
            padding: 8px 12px;
            border-radius: 12px;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .switch-btn.active {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
        }

        .spinning-record {
            animation: spin 4s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* New card hover effects */
        .song-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            border: 3px solid #333;
            border-radius: 50%;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
            overflow: hidden;
            cursor: pointer;
            min-height: 200px;
            max-width: 200px;
            margin: 0 auto;
        }

        .song-card::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
        }

        .song-card::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: #1a1a1a;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }

        .song-card-grooves {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            z-index: 0;
        }

        .groove {
            position: absolute;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .groove:nth-child(1) {
            width: 90%;
            height: 90%;
        }

        .groove:nth-child(2) {
            width: 80%;
            height: 80%;
        }

        .groove:nth-child(3) {
            width: 70%;
            height: 70%;
        }

        .groove:nth-child(4) {
            width: 60%;
            height: 60%;
        }

        .song-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 20px 40px rgba(168, 85, 247, 0.3);
            border-color: rgba(168, 85, 247, 0.5);
        }

        .song-card:hover .record-content {
            transform: rotate(360deg);
        }

        .record-content {
            position: relative;
            z-index: 3;
            text-align: center;
            padding: 15px 20px 2px 20px;
            transition: transform 0.6s ease;
            max-width: 200px;
            height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

        .record-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            line-height: 1.2;
            flex: 1;
            display: flex;
            align-items: center;
            text-align: center;
            margin-bottom: auto;
        }

        .record-bottom {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            margin-top: auto;
            padding-bottom: 0px;
        }

        .record-version {
            display: inline-block;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            border: 2px solid rgba(168, 85, 247, 0.6);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        .record-date {
            font-size: 0.6rem;
            color: #999;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
            margin-top: 1px;
        }

        .delete-record-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Enhanced navigation */
        .nav-glass {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(168, 85, 247, 0.1);
        }

        /* Improved input styling */
        .glass-input {
            background: rgba(31, 41, 55, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(168, 85, 247, 0.2);
            transition: all 0.2s ease;
        }

        .glass-input:focus {
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
        }

        /* Improved button styling */
        .btn-primary {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(168, 85, 247, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .section-suggestions {
            position: fixed;
            background: #374151;
            border: 1px solid #4B5563;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 9999;
            max-height: 200px;
            overflow-y: auto;
            min-width: 150px;
        }
        
        .suggestion-item {
            transition: background-color 0.2s ease;
        }
        
        .suggestion-item:hover {
            background-color: #4B5563 !important;
        }
        
        .section-suggestions::-webkit-scrollbar {
            width: 6px;
        }
        
        .section-suggestions::-webkit-scrollbar-track {
            background: #374151;
        }
        
        .section-suggestions::-webkit-scrollbar-thumb {
            background: #6B7280;
            border-radius: 3px;
        }
        
        .section-suggestions::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }

        .color-setting {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .color-input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }

        .color-input::-webkit-color-swatch-wrapper {
            padding: 0;
            border-radius: 4px;
            border: 1px solid #374151;
        }

        .color-input::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        .color-input::-moz-color-swatch {
            border: 1px solid #374151;
            border-radius: 4px;
        }

        /* Theme Styles */
        .theme-light {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
            color: #1f2937;
        }

        .theme-light .text-white {
            color: #1f2937 !important;
        }

        .theme-light .text-gray-300 {
            color: #4b5563 !important;
        }

        .theme-light .text-gray-400 {
            color: #6b7280 !important;
        }

        .theme-light .text-gray-500 {
            color: #9ca3af !important;
        }

        .theme-light .bg-gray-800 {
            background-color: #f9fafb !important;
        }

        .theme-light .bg-gray-700 {
            background-color: #ffffff !important;
            border: 1px solid #e5e7eb;
        }

        .theme-light .bg-gray-600 {
            background-color: #f3f4f6 !important;
        }

        .theme-light .border-gray-600 {
            border-color: #d1d5db !important;
        }

        .theme-light .border-gray-700 {
            border-color: #e5e7eb !important;
        }

        .theme-light .song-card {
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .theme-light .song-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .theme-light .groove {
            border-color: #e5e7eb !important;
        }

        .theme-light .lyrics-section-bubble {
            background-color: #ffffff;
            border-color: #e5e7eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .theme-light textarea {
            background-color: transparent;
            color: #1f2937;
        }

        .theme-light .glass-input {
            background-color: rgba(255, 255, 255, 0.8);
            border-color: #e5e7eb;
        }

        /* Auto theme - follows system preference */
        @media (prefers-color-scheme: light) {
            .theme-auto {
                background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
                color: #1f2937;
            }
            
            .theme-auto .text-white {
                color: #1f2937 !important;
            }
            
            .theme-auto .bg-gray-800 {
                background-color: #f9fafb !important;
            }
            
            .theme-auto .bg-gray-700 {
                background-color: #ffffff !important;
            }
        }
    </style>
</head>

<body class="text-white min-h-screen">

    <nav class="sticky top-0 z-20 nav-glass shadow-lg">
        <div class="container mx-auto flex justify-between items-center p-4">
            <div class="text-2xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                ✨ SunoSongsSistent
            </div>
            <div class="flex items-center gap-4">
                <div class="relative">
                    <button id="file-menu-btn" class="text-gray-400 hover:text-white transition-colors"
                        title="File Menu">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                        </svg>
                    </button>
                    <div id="file-menu-dropdown" class="menu-dropdown">
                        <label for="song-importer" class="menu-dropdown-item block">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-green-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-download text-green-400 text-sm"></i>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-200">Import Song</span>
                                    <p class="text-xs text-gray-400">Load from .json file</p>
                                </div>
                            </div>
                        </label>
                        <input type="file" id="song-importer" class="hidden" accept=".json">
                        <button id="export-song-btn" class="menu-dropdown-item w-full text-left" disabled>
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-upload text-blue-400 text-sm"></i>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-200">Export Current Song</span>
                                    <p class="text-xs text-gray-400">Save as .json file</p>
                                </div>
                            </div>
                        </button>
                        <button id="create-manual-backup-btn" class="menu-dropdown-item w-full text-left">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-archive text-purple-400 text-sm"></i>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-200">Create Backup</span>
                                    <p class="text-xs text-gray-400">Backup all songs now</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
                <div class="relative">
                    <button id="settings-btn" class="text-gray-400 hover:text-white transition-colors" title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                    <div id="settings-dropdown" class="menu-dropdown" style="min-width: 320px;">
                        <div class="menu-dropdown-item">
                            <div class="flex items-center justify-between w-full gap-4">
                                <div class="flex items-center gap-3 flex-1">
                                    <div class="w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-clock text-blue-400 text-sm"></i>
                                    </div>
                                    <span class="text-sm font-medium text-gray-200">Auto-save</span>
                                </div>
                                <select id="auto-save-frequency"
                                    class="bg-slate-700/80 text-white rounded-lg px-3 py-2 text-sm border border-slate-600/50 focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-400/20 transition-all min-w-[120px]">
                                    <option value="0">Disabled</option>
                                    <option value="30000">30 seconds</option>
                                    <option value="60000">1 minute</option>
                                    <option value="120000">2 minutes</option>
                                    <option value="300000" selected>5 minutes</option>
                                    <option value="600000">10 minutes</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="menu-dropdown-item border-t border-slate-600/30">
                            <div class="flex items-center justify-between w-full gap-4">
                                <div class="flex items-center gap-3 flex-1">
                                    <div class="w-8 h-8 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-palette text-purple-400 text-sm"></i>
                                    </div>
                                    <span class="text-sm font-medium text-gray-200">Colors</span>
                                </div>
                                <button id="open-colors-modal" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 min-w-[120px]">
                                    Customize
                                </button>
                            </div>
                        </div>
                        
                        <div class="menu-dropdown-item border-t border-slate-600/30">
                            <div class="flex items-center justify-between w-full gap-4">
                                <div class="flex items-center gap-3 flex-1">
                                    <div class="w-8 h-8 bg-amber-500/20 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-sun text-amber-400 text-sm"></i>
                                    </div>
                                    <span class="text-sm font-medium text-gray-200">Theme</span>
                                </div>
                                <select id="theme-select"
                                    class="bg-slate-700/80 text-white rounded-lg px-3 py-2 text-sm border border-slate-600/50 focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-400/20 transition-all min-w-[120px]">
                                    <option value="dark">🌙 Dark</option>
                                    <option value="light">☀️ Light</option>
                                    <option value="auto">🔄 Auto</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div id="app" class="p-4 sm:p-6 lg:p-8">
        <div id="jukebox-view" class="relative">
            <div id="jukebox-grid" class="jukebox-grid"></div>
            <button id="create-new-song-fab"
                class="fab fixed bottom-8 left-8 w-20 h-20 rounded-full shadow-lg flex items-center justify-center bg-gradient-to-br from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 transition-all duration-300"
                title="Create New Song">
                <svg class="w-full h-full" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <!-- Spinning gradient background record -->
                    <g class="spinning-record" transform-origin="50 50">
                        <circle cx="50" cy="50" r="48" fill="#111827" stroke="#374151" stroke-width="2" />
                        <circle cx="50" cy="50" r="42" fill="none" stroke="url(#sheen)" stroke-width="1.5" />
                        <circle cx="50" cy="50" r="36" fill="none" stroke="#222222" stroke-width="1.5" />
                        <circle cx="50" cy="50" r="30" fill="none" stroke="#2a2a2a" stroke-width="1.5" />
                        <circle cx="50" cy="50" r="20" fill="url(#spinningLabelGradient)" />
                        <circle cx="50" cy="50" r="5" fill="#111827" />
                    </g>

                    <!-- Static record player arm (moved outside record, bigger) -->
                    <g class="record-arm">
                        <!-- Arm base/pivot -->
                        <circle cx="80" cy="15" r="4" fill="#4a5568" stroke="#718096" stroke-width="1.5" />
                        <!-- Arm shaft (bigger and longer) -->
                        <line x1="80" y1="15" x2="50" y2="50" stroke="#4a5568" stroke-width="4"
                            stroke-linecap="round" />
                        <!-- Arm head (where plus will be) -->
                        <circle cx="50" cy="50" r="10" fill="none" stroke="#4a5568" stroke-width="2" opacity="0.7" />
                    </g>

                    <!-- Static plus sign (centered and larger) -->
                    <g class="plus-sign">
                        <path d="M 50 35 V 65 M 35 50 H 65" stroke="white" stroke-width="5" stroke-linecap="round" />
                    </g>

                    <defs>
                        <linearGradient id="sheen" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#555;stop-opacity:1" />
                            <stop offset="25%" style="stop-color:#2a2a2a;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#555;stop-opacity:1" />
                            <stop offset="75%" style="stop-color:#2a2a2a;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#555;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="spinningLabelGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#c084fc;stop-opacity:1" />
                            <stop offset="25%" style="stop-color:#a855f7;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#7c3aed;stop-opacity:1" />
                            <stop offset="75%" style="stop-color:#6366f1;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#c084fc;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                </svg>
            </button>
        </div>

        <div id="song-ui-view" class="hidden">
            <!-- Compact Header -->
            <div class="flex justify-between items-center mb-4 bg-black/20 backdrop-blur-xl border border-white/10 rounded-2xl p-4">
                <div class="flex items-center gap-4">
                    <button id="back-to-jukebox" class="text-purple-400 hover:underline text-sm">&larr; Back</button>
                    <h1 id="song-title" class="text-2xl font-bold" contenteditable="true"></h1>
                </div>
                <div class="flex items-center gap-3">
                    <div id="auto-save-status" class="text-xs text-gray-400 transition-opacity duration-500 opacity-0">
                    </div>
                    <div class="relative inline-block text-left">
                        <button type="button" id="version-picker-btn" title="Select Version"
                            class="inline-flex justify-center rounded-xl border border-purple-500/30 shadow-lg px-4 py-2 glass-input text-sm font-medium text-white hover:border-purple-400/50 focus:outline-none transition-all duration-200">
                            <span id="version-display"
                                class="font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent"></span>
                            <svg class="-mr-1 ml-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="version-dropdown" class="menu-dropdown version-dropdown-content"></div>
                    </div>
                    <!-- Version Control & Action Buttons -->
                    <div class="flex items-center gap-2">
                        <button id="create-version-btn" title="Create New Version"
                            class="inline-flex justify-center items-center rounded-xl border border-purple-500/30 shadow-lg px-4 py-2 glass-input text-sm font-medium text-white hover:border-purple-400/50 focus:outline-none transition-all duration-200 btn-secondary">
                            ✨
                        </button>
                        <button id="save-draft-btn" title="Save Draft"
                            class="inline-flex justify-center items-center rounded-xl border border-purple-500/30 shadow-lg px-4 py-2 glass-input text-sm font-medium text-white hover:border-purple-400/50 focus:outline-none transition-all duration-200 btn-primary">
                            💾
                        </button>
                        <button id="delete-song-editor-btn" title="Delete Song"
                            class="inline-flex justify-center items-center rounded-xl border border-red-500/30 shadow-lg px-4 py-2 glass-input text-sm font-medium text-white hover:border-red-400/50 focus:outline-none transition-all duration-200 hover:bg-red-500/10">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-6">
                <!-- Lyrics Column - Takes 2/3 of space -->
                <div class="col-span-2 relative">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-semibold text-purple-300">Lyrics</h2>
                        <div class="flex items-center gap-3">
                            <button id="copy-lyrics-btn"
                                class="glass-input px-2 py-1 rounded-lg text-xs border border-purple-500/20 hover:border-purple-400/40 transition-colors text-purple-400 hover:text-purple-300"
                                title="Copy All Lyrics">
                                <i class="fas fa-copy"></i>
                            </button>
                            <div
                                class="glass-input p-1 rounded-lg text-xs flex items-center border border-purple-500/20">
                                <button id="bubbles-view-btn" class="switch-btn active" title="Bubble View">
                                    <i class="fas fa-wand-magic-sparkles text-sm"></i>
                                </button>
                                <button id="text-view-btn" class="switch-btn" title="Text View">
                                    <span class="font-mono font-bold text-xs">Aa</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="lyrics-editor-container"
                        class="glass-input p-4 rounded-xl h-[75vh] overflow-y-auto border-0"></div>
                    <textarea id="plain-text-editor"
                        class="glass-input p-4 rounded-xl h-[75vh] w-full editor-font text-white hidden resize-none outline-none border-0"
                        placeholder="Write your lyrics here..."></textarea>
                </div>

                <!-- Sidebar - Takes 1/3 of space -->
                <div class="space-y-4">
                    <div>
                        <h2 class="text-lg font-semibold mb-2 text-purple-300">Style</h2>
                        <div class="glass-input p-3 rounded-xl"><textarea id="style-textarea"
                                class="w-full h-20 bg-transparent text-gray-200 resize-none outline-none border-0 text-sm"
                                placeholder="Describe the musical style..."></textarea></div>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold mb-2 text-purple-300">Links</h2>
                        <div class="glass-input p-3 rounded-xl">
                            <div id="links-list"></div>
                            <div class="flex mt-2"><input type="text" id="new-link-input" placeholder="Add a new link"
                                    class="flex-grow glass-input rounded-l-xl p-2 outline-none border-0 text-sm"><button
                                    id="add-link-button"
                                    class="btn-primary text-white font-bold py-2 px-4 rounded-r-xl border-0 text-sm">Add</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold mb-2 text-purple-300">Notes</h2>
                        <div class="glass-input p-3 rounded-xl"><textarea id="notes-textarea"
                                class="w-full h-20 bg-transparent text-gray-200 resize-none outline-none border-0 text-sm"
                                placeholder="Add your notes here..."></textarea></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bubble Selection Counter -->
    <div id="bubble-selection-count" class="bubble-selection-count">
        <span id="selection-count-text">0 bubbles selected</span>
        <div class="flex items-center gap-2 mt-1">
            <button id="copy-selected-bubbles" class="text-xs bg-green-600/20 hover:bg-green-600/40 px-2 py-1 rounded transition-colors">
                <i class="fas fa-copy mr-1"></i> Copy
            </button>
            <button id="delete-selected-bubbles" class="text-xs bg-red-600/20 hover:bg-red-600/40 px-2 py-1 rounded transition-colors">
                <i class="fas fa-trash mr-1"></i> Delete
            </button>
        </div>
    </div>

    <!-- Color Customization Modal -->
    <div id="colors-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-gray-800 rounded-xl shadow-2xl border border-gray-700 max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-700">
                <div class="flex items-center gap-3">
                    <i class="fas fa-palette text-purple-400 text-xl"></i>
                    <h2 class="text-xl font-semibold text-white">Section Colors</h2>
                </div>
                <div class="flex items-center gap-2">
                    <button id="reset-colors-btn" class="text-sm text-blue-400 hover:text-blue-300 px-3 py-1 rounded hover:bg-gray-700 transition-colors">
                        <i class="fas fa-undo mr-1"></i>
                        Reset to Defaults
                    </button>
                    <button id="close-colors-modal" class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-gray-700 transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="color-setting" data-section="verse">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Verse</label>
                        <div class="flex items-center gap-2">
                            <input type="color" class="color-input w-12 h-8 rounded cursor-pointer border border-gray-600" value="#3B82F6">
                            <div class="color-hex-display flex-1 bg-gray-700 rounded px-3 py-1 text-sm text-gray-300 font-mono">#3B82F6</div>
                        </div>
                    </div>
                    <div class="color-setting" data-section="chorus">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Chorus</label>
                        <div class="flex items-center gap-2">
                            <input type="color" class="color-input w-12 h-8 rounded cursor-pointer border border-gray-600" value="#8B5CF6">
                            <div class="color-hex-display flex-1 bg-gray-700 rounded px-3 py-1 text-sm text-gray-300 font-mono">#8B5CF6</div>
                        </div>
                    </div>
                    <div class="color-setting" data-section="bridge">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Bridge</label>
                        <div class="flex items-center gap-2">
                            <input type="color" class="color-input w-12 h-8 rounded cursor-pointer border border-gray-600" value="#F97316">
                            <div class="color-hex-display flex-1 bg-gray-700 rounded px-3 py-1 text-sm text-gray-300 font-mono">#F97316</div>
                        </div>
                    </div>
                    <div class="color-setting" data-section="preChorus">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Pre-Chorus</label>
                        <div class="flex items-center gap-2">
                            <input type="color" class="color-input w-12 h-8 rounded cursor-pointer border border-gray-600" value="#EAB308">
                            <div class="color-hex-display flex-1 bg-gray-700 rounded px-3 py-1 text-sm text-gray-300 font-mono">#EAB308</div>
                        </div>
                    </div>
                    <div class="color-setting" data-section="intro">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Intro</label>
                        <div class="flex items-center gap-2">
                            <input type="color" class="color-input w-12 h-8 rounded cursor-pointer border border-gray-600" value="#10B981">
                            <div class="color-hex-display flex-1 bg-gray-700 rounded px-3 py-1 text-sm text-gray-300 font-mono">#10B981</div>
                        </div>
                    </div>
                    <div class="color-setting" data-section="outro">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Outro</label>
                        <div class="flex items-center gap-2">
                            <input type="color" class="color-input w-12 h-8 rounded cursor-pointer border border-gray-600" value="#EF4444">
                            <div class="color-hex-display flex-1 bg-gray-700 rounded px-3 py-1 text-sm text-gray-300 font-mono">#EF4444</div>
                        </div>
                    </div>
                    <div class="color-setting" data-section="hook">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Hook</label>
                        <div class="flex items-center gap-2">
                            <input type="color" class="color-input w-12 h-8 rounded cursor-pointer border border-gray-600" value="#A3A3A3">
                            <div class="color-hex-display flex-1 bg-gray-700 rounded px-3 py-1 text-sm text-gray-300 font-mono">#A3A3A3</div>
                        </div>
                    </div>
                    <div class="color-setting" data-section="refrain">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Refrain</label>
                        <div class="flex items-center gap-2">
                            <input type="color" class="color-input w-12 h-8 rounded cursor-pointer border border-gray-600" value="#06B6D4">
                            <div class="color-hex-display flex-1 bg-gray-700 rounded px-3 py-1 text-sm text-gray-300 font-mono">#06B6D4</div>
                        </div>
                    </div>
                    <div class="color-setting" data-section="breakdown">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Breakdown</label>
                        <div class="flex items-center gap-2">
                            <input type="color" class="color-input w-12 h-8 rounded cursor-pointer border border-gray-600" value="#6B7280">
                            <div class="color-hex-display flex-1 bg-gray-700 rounded px-3 py-1 text-sm text-gray-300 font-mono">#6B7280</div>
                        </div>
                    </div>
                    <div class="color-setting" data-section="solo">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Solo</label>
                        <div class="flex items-center gap-2">
                            <input type="color" class="color-input w-12 h-8 rounded cursor-pointer border border-gray-600" value="#EC4899">
                            <div class="color-hex-display flex-1 bg-gray-700 rounded px-3 py-1 text-sm text-gray-300 font-mono">#EC4899</div>
                        </div>
                    </div>
                    <div class="color-setting" data-section="interlude">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Interlude</label>
                        <div class="flex items-center gap-2">
                            <input type="color" class="color-input w-12 h-8 rounded cursor-pointer border border-gray-600" value="#F59E0B">
                            <div class="color-hex-display flex-1 bg-gray-700 rounded px-3 py-1 text-sm text-gray-300 font-mono">#F59E0B</div>
                        </div>
                    </div>
                    <div class="color-setting" data-section="tag">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Tag</label>
                        <div class="flex items-center gap-2">
                            <input type="color" class="color-input w-12 h-8 rounded cursor-pointer border border-gray-600" value="#059669">
                            <div class="color-hex-display flex-1 bg-gray-700 rounded px-3 py-1 text-sm text-gray-300 font-mono">#059669</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end gap-3 p-6 border-t border-gray-700">
                <button id="cancel-colors-btn" class="px-4 py-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors">
                    Cancel
                </button>
                <button id="save-colors-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded transition-colors">
                    <i class="fas fa-save mr-1"></i>
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DB HELPER ---
        const DB_NAME = 'SunoSongsDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'songs';
        let db;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject("Error opening DB");
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    db.createObjectStore(STORE_NAME, { keyPath: 'songKey' });
                };
            });
        }

        function saveSongToDB(songData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(songData);
                request.onsuccess = () => resolve();
                request.onerror = () => reject("Error saving song");
            });
        }

        function deleteSongFromDB(songKey) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(songKey);
                request.onsuccess = () => resolve();
                request.onerror = () => reject("Error deleting song");
            });
        }

        function getAllSongsFromDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject("Error fetching songs");
            });
        }

        // --- DOM Elements ---
        const jukeboxView = document.getElementById('jukebox-view');
        const songUiView = document.getElementById('song-ui-view');
        const backToJukeboxBtn = document.getElementById('back-to-jukebox');
        const songImporter = document.getElementById('song-importer');
        const jukeboxGrid = document.getElementById('jukebox-grid');
        const createNewSongFab = document.getElementById('create-new-song-fab');
        const songTitle = document.getElementById('song-title');
        const versionPickerBtn = document.getElementById('version-picker-btn');
        const versionDisplay = document.getElementById('version-display');
        const versionDropdown = document.getElementById('version-dropdown');
        const lyricsEditorContainer = document.getElementById('lyrics-editor-container');
        const plainTextEditor = document.getElementById('plain-text-editor');
        const bubblesViewBtn = document.getElementById('bubbles-view-btn');
        const textViewBtn = document.getElementById('text-view-btn');
        const copyLyricsBtn = document.getElementById('copy-lyrics-btn');
        const styleTextarea = document.getElementById('style-textarea');
        const notesTextarea = document.getElementById('notes-textarea');
        const linksList = document.getElementById('links-list');
        const newLinkInput = document.getElementById('new-link-input');
        const addLinkButton = document.getElementById('add-link-button');
        const saveDraftBtn = document.getElementById('save-draft-btn');
        const createVersionBtn = document.getElementById('create-version-btn');
        const autoSaveStatus = document.getElementById('auto-save-status');
        const fileMenuBtn = document.getElementById('file-menu-btn');
        const fileMenuDropdown = document.getElementById('file-menu-dropdown');
        const exportSongBtn = document.getElementById('export-song-btn');
        const createManualBackupBtn = document.getElementById('create-manual-backup-btn');
        const deleteSongEditorBtn = document.getElementById('delete-song-editor-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsDropdown = document.getElementById('settings-dropdown');
        const autoSaveFrequencySelect = document.getElementById('auto-save-frequency');
        const themeSelect = document.getElementById('theme-select');
        const colorsModal = document.getElementById('colors-modal');
        const openColorsModalBtn = document.getElementById('open-colors-modal');
        const closeColorsModalBtn = document.getElementById('close-colors-modal');
        const resetColorsBtn = document.getElementById('reset-colors-btn');
        const saveColorsBtn = document.getElementById('save-colors-btn');
        const cancelColorsBtn = document.getElementById('cancel-colors-btn');
        const bubbleSelectionCount = document.getElementById('bubble-selection-count');
        const selectionCountText = document.getElementById('selection-count-text');
        const copySelectedBubblesBtn = document.getElementById('copy-selected-bubbles');
        const deleteSelectedBubblesBtn = document.getElementById('delete-selected-bubbles');

        // --- State ---
        let currentSongKey = null;
        let allSongs = {};
        const sectionColors = {};
        let autoSaveInterval = null;
        let currentEditorMode = 'bubbles';
        let isDirty = false;
        let selectedBubbles = new Set();

        // Settings
        let settings = {
            autoSaveFrequency: 300000, // 5 minutes in milliseconds (default)
            theme: 'dark', // Default theme
            lastBackupTime: null, // Track last backup time
            sectionColors: {
                verse: '#3B82F6',
                chorus: '#8B5CF6', 
                bridge: '#F97316',
                preChorus: '#EAB308',
                intro: '#10B981',
                outro: '#EF4444',
                hook: '#A3A3A3',
                refrain: '#06B6D4',
                breakdown: '#6B7280',
                solo: '#EC4899',
                interlude: '#F59E0B',
                tag: '#059669'
            }
        };
        const AUTO_SAVE_TIME = () => settings.autoSaveFrequency;

        // --- Sample Data ---
        const sampleSong = {
            songKey: "chinese_roomba",
            songName: "Chinese Roomba",
            versions: [{
                version: "00000",
                creationDate: new Date().toISOString(),
                lyrics: [
                    `[Intro]\n"Opa! Gimme the microphone"`,
                    `This is a section without a tag.\nIt should be colorless.`,
                    `[Verse]\nBack then, you'd meet at the store,\nSame town, street, building, or next door.`
                ],
                style: "A fusion of Arabic ballad and Electro-Funk.",
                links: ["https://suno.com/song/example1"],
                notes: ""
            }]
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('Starting app initialization...');
                await openDB();
                console.log('Database opened successfully');
                
                loadSettings();
                console.log('Settings loaded');
                
                const songsFromDB = await getAllSongsFromDB();
                console.log('Songs from DB:', songsFromDB.length, 'songs found');
                
                if (songsFromDB.length === 0) {
                    console.log('No songs found in database, checking for backup recovery...');
                    
                    // Attempt to recover from localStorage backup
                    const recovered = await attemptDataRecovery();
                    
                    if (!recovered) {
                        console.log('No recovery possible, adding sample song');
                        allSongs[sampleSong.songKey] = sampleSong;
                        await saveSongToDB(sampleSong);
                        console.log('Sample song saved');
                    } else {
                        console.log('Data recovered from backup successfully');
                    }
                } else {
                    console.log('Loading existing songs from database');
                    songsFromDB.forEach(song => {
                        console.log('Loading song:', song.songName);
                        allSongs[song.songKey] = song;
                    });
                }
                console.log('Total songs in memory:', Object.keys(allSongs).length);
                
                // Check if we need to create an auto backup
                await checkAndCreateAutoBackup();
                
                init();
            } catch (error) {
                console.error('Error during initialization:', error);
                // Show error to user
                alert('Error loading songs: ' + error.message);
            }
        });

        function init() {
            renderJukebox();
            initializeSettings();
            backToJukeboxBtn.addEventListener('click', () => {
                clearInterval(autoSaveInterval);
                showJukeboxView();
            });
            songImporter.addEventListener('change', handleFileImport);
            createNewSongFab.addEventListener('click', createNewSong);
            saveDraftBtn.addEventListener('click', () => saveDraft(true));
            createVersionBtn.addEventListener('click', createVersion);
            versionPickerBtn.addEventListener('click', () => {
                versionDropdown.style.display = versionDropdown.style.display === 'block' ? 'none' : 'block';
            });
            addLinkButton.addEventListener('click', addLink);
            fileMenuBtn.addEventListener('click', () => {
                fileMenuDropdown.style.display = fileMenuDropdown.style.display === 'block' ? 'none' : 'block';
            });
            settingsBtn.addEventListener('click', () => {
                settingsDropdown.style.display = settingsDropdown.style.display === 'block' ? 'none' : 'block';
            });
            exportSongBtn.addEventListener('click', exportCurrentSong);
            deleteSongEditorBtn.addEventListener('click', deleteCurrentSong);
            songTitle.addEventListener('blur', renameSong);
            bubblesViewBtn.addEventListener('click', () => switchToBubbleView());
            textViewBtn.addEventListener('click', () => switchToTextView());
            copyLyricsBtn.addEventListener('click', copyAllLyrics);

            // Bubble selection event listeners
            copySelectedBubblesBtn.addEventListener('click', copySelectedBubbles);
            deleteSelectedBubblesBtn.addEventListener('click', deleteSelectedBubbles);

            // Settings event listeners
            autoSaveFrequencySelect.addEventListener('change', updateAutoSaveSettings);
            themeSelect.addEventListener('change', updateThemeSettings);
            
            // Backup event listeners
            createManualBackupBtn.addEventListener('click', () => createAutoBackup(true));
            
            // Color modal event listeners
            openColorsModalBtn.addEventListener('click', openColorsModal);
            closeColorsModalBtn.addEventListener('click', closeColorsModal);
            cancelColorsBtn.addEventListener('click', closeColorsModal);
            saveColorsBtn.addEventListener('click', saveColorsAndClose);
            resetColorsBtn.addEventListener('click', resetSectionColors);
            
            // Close modal when clicking backdrop
            colorsModal.addEventListener('click', (e) => {
                if (e.target === colorsModal) {
                    closeColorsModal();
                }
            });
            
            // Color input event listeners in modal
            colorsModal.querySelectorAll('.color-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const hexDisplay = e.target.closest('.color-setting').querySelector('.color-hex-display');
                    hexDisplay.textContent = e.target.value.toUpperCase();
                });
            });

            [styleTextarea, notesTextarea, newLinkInput, plainTextEditor].forEach(el => el.addEventListener('input', () => isDirty = true));

            // Auto-resize plain text editor
            plainTextEditor.addEventListener('input', (e) => {
                e.target.style.height = 'auto';
                e.target.style.height = e.target.scrollHeight + 'px';
            });

            lyricsEditorContainer.addEventListener('dragover', e => {
                e.preventDefault();
                const draggingElement = document.querySelector('.dragging');
                if (!draggingElement) return;
                const afterElement = getDragAfterElement(lyricsEditorContainer, e.clientY);
                lyricsEditorContainer.insertBefore(draggingElement, afterElement);
            });

            window.addEventListener('click', (event) => {
                if (!versionPickerBtn.contains(event.target) && !versionDropdown.contains(event.target)) {
                    versionDropdown.style.display = 'none';
                }
                if (!fileMenuBtn.contains(event.target) && !fileMenuDropdown.contains(event.target)) {
                    fileMenuDropdown.style.display = 'none';
                }
                if (!settingsBtn.contains(event.target) && !settingsDropdown.contains(event.target)) {
                    settingsDropdown.style.display = 'none';
                }
                
                // Clear bubble selection when clicking outside
                if (!lyricsEditorContainer.contains(event.target) && 
                    !event.target.closest('.bubble-selection-count')) {
                    clearBubbleSelection();
                }
            });

            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Only work in bubble view
                if (currentEditorMode !== 'bubbles') return;
                
                // Ctrl+A or Cmd+A - Select all bubbles
                if ((e.ctrlKey || e.metaKey) && e.key === 'a' && e.target === document.body) {
                    e.preventDefault();
                    selectAllBubbles();
                }
                
                // Delete key - Delete selected bubbles
                if (e.key === 'Delete' && selectedBubbles.size > 0 && e.target === document.body) {
                    e.preventDefault();
                    deleteSelectedBubbles();
                }
                
                // Escape key - Clear selection
                if (e.key === 'Escape') {
                    clearBubbleSelection();
                }
                
                // Ctrl+C or Cmd+C - Copy selected bubbles
                if ((e.ctrlKey || e.metaKey) && e.key === 'c' && selectedBubbles.size > 0 && e.target === document.body) {
                    e.preventDefault();
                    copySelectedBubbles();
                }
            });
        }

        // --- Settings Management ---
        function loadSettings() {
            const savedSettings = localStorage.getItem('sunoSongsSettings');
            if (savedSettings) {
                settings = { ...settings, ...JSON.parse(savedSettings) };
            }
        }

        function saveSettings() {
            localStorage.setItem('sunoSongsSettings', JSON.stringify(settings));
        }

        // --- Auto Backup Management ---
        function shouldCreateAutoBackup() {
            if (!settings.lastBackupTime) {
                return true; // First time, create backup
            }
            
            const lastBackup = new Date(settings.lastBackupTime);
            const now = new Date();
            const hoursSinceLastBackup = (now - lastBackup) / (1000 * 60 * 60);
            
            return hoursSinceLastBackup >= 24;
        }

        // Recovery function to restore from localStorage backup if needed
        async function attemptDataRecovery() {
            const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('sunoSongs_backup_'));
            if (backupKeys.length === 0) {
                console.log('No localStorage backups found for recovery');
                return false;
            }
            
            try {
                // Get the most recent backup
                const latestBackupKey = backupKeys.sort().pop();
                const backupData = JSON.parse(localStorage.getItem(latestBackupKey));
                
                console.log(`Found backup from ${backupData.timestamp} with ${backupData.songsCount} songs`);
                
                // Restore songs to database
                for (const song of backupData.songs) {
                    await saveSongToDB(song);
                    allSongs[song.songKey] = song;
                }
                
                // Restore settings if available
                if (backupData.settings) {
                    settings = { ...settings, ...backupData.settings };
                    saveSettings();
                }
                
                console.log('Data recovery completed successfully');
                return true;
                
            } catch (error) {
                console.error('Error during data recovery:', error);
                return false;
            }
        }

        async function createAutoBackup(isManual = false) {
            try {
                console.log(isManual ? 'Creating manual backup...' : 'Creating automatic backup...');
                
                // Get all songs from database to ensure we have the latest
                const allSongsFromDB = await getAllSongsFromDB();
                
                if (allSongsFromDB.length === 0) {
                    console.log('No songs to backup');
                    if (isManual) {
                        showSaveStatus('No songs to backup');
                    }
                    return;
                }
                
                // Create backup data with localStorage settings for complete backup
                const backupData = {
                    timestamp: new Date().toISOString(),
                    version: '1.1',
                    songsCount: allSongsFromDB.length,
                    songs: allSongsFromDB,
                    settings: settings // Include app settings in backup
                };
                
                // Store backup in localStorage as well for automatic recovery
                const backupKey = `sunoSongs_backup_${Date.now()}`;
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                
                // Keep only last 5 backups in localStorage to avoid storage bloat
                const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('sunoSongs_backup_'));
                if (backupKeys.length > 5) {
                    // Sort by timestamp and remove oldest
                    backupKeys.sort().slice(0, -5).forEach(oldKey => {
                        localStorage.removeItem(oldKey);
                    });
                }
                
                // For manual backups, also offer file download
                if (isManual) {
                    const now = new Date();
                    const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
                    const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-'); // HH-MM-SS
                    const filename = `backup/SunoSongs_Manual_${dateStr}_${timeStr}.json`;
                    
                    // Create and download backup file
                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    showSaveStatus(`Manual backup created: ${allSongsFromDB.length} songs backed up`);
                }
                
                // Update last backup time
                settings.lastBackupTime = new Date().toISOString();
                saveSettings();
                
                console.log(isManual ? 'Manual backup completed' : `Auto backup completed - ${allSongsFromDB.length} songs saved to localStorage`);
                
            } catch (error) {
                console.error('Error creating backup:', error);
                if (isManual) {
                    showSaveStatus('Backup failed - check console for details');
                }
            }
        }

        async function checkAndCreateAutoBackup() {
            if (shouldCreateAutoBackup()) {
                console.log('24+ hours since last backup, creating silent auto backup...');
                await createAutoBackup(false); // Silent backup
            } else {
                const lastBackup = new Date(settings.lastBackupTime);
                const hoursSince = Math.floor((new Date() - lastBackup) / (1000 * 60 * 60));
                console.log(`Last backup was ${hoursSince} hours ago, no backup needed yet`);
            }
        }

        function initializeSettings() {
            autoSaveFrequencySelect.value = settings.autoSaveFrequency.toString();
            themeSelect.value = settings.theme;
            applyTheme(settings.theme);
            initializeColorSettings();
        }

        function updateAutoSaveSettings() {
            settings.autoSaveFrequency = parseInt(autoSaveFrequencySelect.value);
            saveSettings();

            // Restart auto-save with new settings if we're in a song
            if (currentSongKey) {
                clearInterval(autoSaveInterval);
                if (settings.autoSaveFrequency > 0) {
                    autoSaveInterval = setInterval(saveDraft, AUTO_SAVE_TIME());
                }
            }
        }

        function updateThemeSettings() {
            settings.theme = themeSelect.value;
            saveSettings();
            applyTheme(settings.theme);
        }

        function applyTheme(theme) {
            const body = document.body;
            
            // Remove existing theme classes
            body.classList.remove('theme-light', 'theme-dark', 'theme-auto');
            
            if (theme === 'light') {
                body.classList.add('theme-light');
            } else if (theme === 'dark') {
                body.classList.add('theme-dark');
            } else if (theme === 'auto') {
                body.classList.add('theme-auto');
                // Apply auto theme based on system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                    body.classList.add('theme-light');
                } else {
                    body.classList.add('theme-dark');
                }
                
                // Listen for system theme changes
                if (window.matchMedia) {
                    const mediaQuery = window.matchMedia('(prefers-color-scheme: light)');
                    mediaQuery.addEventListener('change', (e) => {
                        if (settings.theme === 'auto') {
                            body.classList.remove('theme-light', 'theme-dark');
                            if (e.matches) {
                                body.classList.add('theme-light');
                            } else {
                                body.classList.add('theme-dark');
                            }
                        }
                    });
                }
            }
        }

        function initializeColorSettings() {
            // Color settings are now initialized when modal opens
            // This function maintained for compatibility
        }

        function updateSectionColor(section, color) {
            settings.sectionColors[section] = color;
            saveSettings();
            
            // Update all existing bubbles with this section
            refreshAllBubbleColors();
        }

        function resetSectionColors() {
            settings.sectionColors = {
                verse: '#3B82F6',
                chorus: '#8B5CF6', 
                bridge: '#F97316',
                preChorus: '#EAB308',
                intro: '#10B981',
                outro: '#EF4444',
                hook: '#A3A3A3',
                refrain: '#06B6D4',
                breakdown: '#6B7280',
                solo: '#EC4899',
                interlude: '#F59E0B',
                tag: '#059669'
            };
            saveSettings();
            initializeModalColors(); // Update modal if open
            refreshAllBubbleColors();
        }

        function refreshAllBubbleColors() {
            // Update all existing bubbles to use new colors
            document.querySelectorAll('.lyrics-section-bubble').forEach(bubble => {
                const textarea = bubble.querySelector('textarea');
                if (textarea) {
                    const lines = textarea.value.split('\n');
                    const sectionId = extractSectionId(lines[0]);
                    if (sectionId) {
                        const newColor = getSectionColor(sectionId);
                        bubble.style.backgroundColor = newColor + '20'; // 20% opacity
                        bubble.style.borderColor = newColor;
                    }
                }
            });
        }

        // --- Color Modal Management ---
        function openColorsModal() {
            // Initialize modal with current color values
            initializeModalColors();
            colorsModal.classList.remove('hidden');
            settingsDropdown.style.display = 'none';
        }

        function closeColorsModal() {
            colorsModal.classList.add('hidden');
        }

        function initializeModalColors() {
            colorsModal.querySelectorAll('.color-setting').forEach(setting => {
                const section = setting.dataset.section;
                const colorInput = setting.querySelector('.color-input');
                const hexDisplay = setting.querySelector('.color-hex-display');
                
                if (settings.sectionColors[section]) {
                    const color = settings.sectionColors[section];
                    colorInput.value = color;
                    hexDisplay.textContent = color.toUpperCase();
                }
            });
        }

        function saveColorsAndClose() {
            // Save all color changes
            colorsModal.querySelectorAll('.color-setting').forEach(setting => {
                const section = setting.dataset.section;
                const colorInput = setting.querySelector('.color-input');
                settings.sectionColors[section] = colorInput.value;
            });
            
            saveSettings();
            refreshAllBubbleColors();
            closeColorsModal();
        }

        // --- View Management ---
        function showJukeboxView() {
            exportSongBtn.disabled = true;
            gsap.to(songUiView, {
                opacity: 0, duration: 0.3, onComplete: () => {
                    songUiView.classList.add('hidden');
                    jukeboxView.classList.remove('hidden');
                    gsap.fromTo(jukeboxView, { opacity: 0 }, { opacity: 1, duration: 0.3 });
                    renderJukebox();
                }
            });
        }
        function showSongUiView(onCompleteCallback) {
            exportSongBtn.disabled = false;
            gsap.to(jukeboxView, {
                opacity: 0, duration: 0.3, onComplete: () => {
                    jukeboxView.classList.add('hidden');
                    songUiView.classList.remove('hidden');
                    gsap.fromTo(songUiView, { opacity: 0 }, { opacity: 1, duration: 0.3, onComplete: onCompleteCallback });
                }
            });
        }

        // --- Jukebox Logic ---
        function renderJukebox() {
            console.log('Rendering jukebox with', Object.keys(allSongs).length, 'songs');
            console.log('Songs object:', allSongs);
            
            jukeboxGrid.innerHTML = '';
            Object.values(allSongs).forEach(song => {
                const latestVersion = song.versions[song.versions.length - 1];
                const card = document.createElement('div');
                card.className = "song-card group";

                const displayVersion = formatVersionString(latestVersion.version);
                const lastUpdated = new Date(latestVersion.creationDate).toLocaleString([], {
                    year: 'numeric', month: 'numeric', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', hour12: false
                });

                card.innerHTML = `
                    <div class="song-card-grooves">
                        <div class="groove"></div>
                        <div class="groove"></div>
                        <div class="groove"></div>
                        <div class="groove"></div>
                    </div>
                    <div class="record-content">
                        <h2 class="record-title">${song.songName}</h2>
                        <div class="record-bottom">
                            <p class="record-date">${lastUpdated}</p>
                            <div class="record-version">${displayVersion}</div>
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => loadSong(song.songKey, latestVersion.version));
                jukeboxGrid.appendChild(card);
            });
        }

        // --- Song Loading & Creation ---
        async function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const songData = JSON.parse(await file.text());
            if (songData && songData.songKey && songData.versions) {
                allSongs[songData.songKey] = songData;
                await saveSongToDB(songData);
                renderJukebox();
            }
            event.target.value = null;
        }

        function loadSong(songKey, versionString) {
            clearInterval(autoSaveInterval);
            isDirty = false;
            currentSongKey = songKey;
            const song = allSongs[currentSongKey];
            const version = song.versions.find(v => v.version === versionString);

            songTitle.textContent = song.songName;
            styleTextarea.value = version.style || '';
            notesTextarea.value = version.notes || '';

            lyricsEditorContainer.innerHTML = '';

            populateVersionPicker();
            renderLinks(version.links || []);

            showSongUiView(() => {
                switchToBubbleView(version.lyrics);
                if (settings.autoSaveFrequency > 0) {
                    autoSaveInterval = setInterval(saveDraft, AUTO_SAVE_TIME());
                }
            });
        }

        async function createNewSong() {
            let untitledCount = 1;
            let newSongKey;
            let newSongName;
            do {
                newSongName = `Untitled Song ${untitledCount}`;
                newSongKey = newSongName.toLowerCase().replace(/\s+/g, '_');
                untitledCount++;
            } while (allSongs[newSongKey]);

            const newSongData = {
                songKey: newSongKey,
                songName: newSongName,
                versions: [{
                    version: `00000`,
                    creationDate: new Date().toISOString(),
                    lyrics: [`[Verse]\nYour lyrics here...`, ''],
                    style: "", links: [], notes: ""
                }]
            };
            allSongs[newSongKey] = newSongData;
            await saveSongToDB(newSongData);
            loadSong(newSongKey, '00000');
        }

        async function renameSong() {
            const newName = songTitle.textContent.trim();
            if (!newName || newName === allSongs[currentSongKey].songName) {
                songTitle.textContent = allSongs[currentSongKey].songName;
                return;
            }

            const newKey = newName.toLowerCase().replace(/\s+/g, '_');
            if (allSongs[newKey]) {
                alert("A song with this name already exists. Please choose a different name.");
                songTitle.textContent = allSongs[currentSongKey].songName;
                return;
            }

            const oldKey = currentSongKey;
            const songData = allSongs[oldKey];

            songData.songKey = newKey;
            songData.songName = newName;
            allSongs[newKey] = songData;
            delete allSongs[oldKey];
            currentSongKey = newKey;

            await saveSongToDB(songData);
            await deleteSongFromDB(oldKey);

            showSaveStatus("Song renamed!");
        }

        // --- LYRICS EDITOR ---
        function switchToBubbleView(lyrics) {
            currentEditorMode = 'bubbles';
            bubblesViewBtn.classList.add('active');
            textViewBtn.classList.remove('active');
            lyricsEditorContainer.classList.remove('hidden');
            plainTextEditor.classList.add('hidden');

            // Convert from text view if switching from text mode
            let lyricsArray;
            if (lyrics) {
                // Loading from saved data
                lyricsArray = lyrics;
            } else if (plainTextEditor.value.trim()) {
                // Convert text editor content to bubbles
                lyricsArray = plainTextEditor.value.split(/\n\s*\n/).filter(section => section.trim());
            } else {
                // Get current bubble content (fallback)
                const sections = [];
                const textareas = lyricsEditorContainer.querySelectorAll('.lyrics-section-bubble textarea');
                textareas.forEach(textarea => {
                    sections.push(textarea.value);
                });
                lyricsArray = sections;
            }

            renderLyricsBubbles(lyricsArray);
            clearBubbleSelection(); // Clear any previous selections
        }

        function switchToTextView() {
            currentEditorMode = 'text';
            textViewBtn.classList.add('active');
            bubblesViewBtn.classList.remove('active');
            plainTextEditor.classList.remove('hidden');
            lyricsEditorContainer.classList.add('hidden');
            clearBubbleSelection(); // Clear bubble selections when switching to text view

            // Convert from bubble view to text - preserve ALL textarea values including empty ones
            const sections = [];
            const textareas = lyricsEditorContainer.querySelectorAll('.lyrics-section-bubble textarea');
            textareas.forEach(textarea => {
                // Don't trim here to preserve exact spacing, and include ALL sections
                sections.push(textarea.value);
            });

            // Remove only the last empty section if it exists (the auto-added empty bubble)
            while (sections.length > 0 && sections[sections.length - 1].trim() === '') {
                sections.pop();
            }

            // Join sections with double newlines to preserve structure
            const textContent = sections.join('\n\n');
            plainTextEditor.value = textContent;

            // Auto-resize the textarea
            plainTextEditor.style.height = 'auto';
            plainTextEditor.style.height = plainTextEditor.scrollHeight + 'px';
        }

        function createBubbleElement(sectionText) {
            // Create container for the whole bubble
            const container = document.createElement('div');
            container.className = 'bubble-container';

            // Create the actual bubble
            const bubble = document.createElement('div');
            bubble.className = 'lyrics-section-bubble relative';

            // Create checkbox positioned absolutely in top-left corner
            const checkbox = document.createElement('div');
            checkbox.className = 'bubble-checkbox';
            checkbox.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleBubbleSelection(container);
            });

            // Create drag handle positioned under the checkbox
            const dragHandle = document.createElement('div');
            dragHandle.className = 'drag-handle';

            const textarea = document.createElement('textarea');
            textarea.value = sectionText;
            textarea.className = 'editor-font';

            // Create control buttons
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'bubble-controls';
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'bubble-control-btn bubble-copy-btn';
            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
            copyBtn.title = 'Copy this bubble';
            copyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                copyBubble(container);
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'bubble-control-btn bubble-delete-btn';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.title = 'Delete this bubble';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteBubble(container);
            });

            controlsDiv.appendChild(copyBtn);
            controlsDiv.appendChild(deleteBtn);

            // Create suggestions dropdown - append to body for proper z-index
            const suggestionsDropdown = document.createElement('div');
            suggestionsDropdown.className = 'section-suggestions fixed bg-gray-800 border border-purple-500/30 rounded-lg shadow-lg max-w-xs hidden';

            // Add elements to bubble
            bubble.appendChild(checkbox);
            bubble.appendChild(dragHandle);
            bubble.appendChild(textarea);
            bubble.appendChild(controlsDiv);

            // Add bubble to container
            container.appendChild(bubble);

            // Append suggestions to body for proper z-index layering
            document.body.appendChild(suggestionsDropdown);

            updateBubbleStyle(bubble);

            // Drag events on the drag handle only
            dragHandle.addEventListener('mousedown', () => {
                container.setAttribute('draggable', 'true');
            });

            container.addEventListener('dragstart', (e) => {
                // Only allow drag if started from drag handle
                if (!e.target.classList.contains('drag-handle') && !e.target.closest('.drag-handle')) {
                    e.preventDefault();
                    return false;
                }
                container.classList.add('dragging');
            });
            
            container.addEventListener('dragend', () => {
                container.classList.remove('dragging');
                container.setAttribute('draggable', 'false');
            });

            textarea.addEventListener('input', (e) => {
                isDirty = true;
                autoResizeTextarea(e);
                maybeAddNewBubble(e);
                updateBubbleStyle(bubble);
                showSectionSuggestions(textarea, suggestionsDropdown);
            });
            
            textarea.addEventListener('keydown', (e) => {
                if (handleSuggestionKeyboard(e, textarea, suggestionsDropdown)) {
                    return; // Suggestion was handled
                }
                handleTabText(e);
            });

            textarea.addEventListener('blur', () => {
                // Hide suggestions with a small delay to allow for clicks
                setTimeout(() => {
                    suggestionsDropdown.classList.add('hidden');
                }, 150);
            });

            // Disable dragging by default until drag handle is clicked
            container.setAttribute('draggable', 'false');

            // Store dropdown reference for cleanup
            container.suggestionsDropdown = suggestionsDropdown;

            return container;
        }

        function updateBubbleStyle(bubble) {
            const textarea = bubble.querySelector('textarea');
            if (!textarea) return;
            const text = textarea.value;
            const firstLine = text.split('\n')[0].trim();

            bubble.classList.remove('unsectioned-bubble', 'empty-bubble');

            if (text.trim() === '') {
                bubble.classList.add('empty-bubble');
                bubble.style.backgroundColor = 'transparent';
            } else if (firstLine.startsWith('[') && firstLine.endsWith(']')) {
                const sectionId = firstLine.substring(1, firstLine.length - 1).split(':')[0].trim();
                bubble.style.backgroundColor = getSectionColor(sectionId);
            } else {
                bubble.classList.add('unsectioned-bubble');
                bubble.style.backgroundColor = 'transparent';
            }
        }

        function renderLyricsBubbles(lyricsArray) {
            lyricsEditorContainer.innerHTML = '';

            if (typeof lyricsArray === 'string') {
                lyricsArray = lyricsArray.split(/\n\s*\n/);
            }

            lyricsArray.forEach(sectionText => {
                lyricsEditorContainer.appendChild(createBubbleElement(sectionText));
            });

            const lastBubble = lyricsEditorContainer.lastElementChild;
            if (!lastBubble || lastBubble.querySelector('textarea').value.trim() !== '') {
                lyricsEditorContainer.appendChild(createBubbleElement(''));
            }

            lyricsEditorContainer.querySelectorAll('textarea').forEach(textarea => {
                autoResizeTextarea({ target: textarea });
            });
        }

        function getLyricsAsArray() {
            if (currentEditorMode === 'bubbles') {
                const sections = [];
                const textareas = lyricsEditorContainer.querySelectorAll('.lyrics-section-bubble textarea');
                textareas.forEach(textarea => {
                    sections.push(textarea.value);
                });
                // Remove empty trailing sections
                while (sections.length > 0 && sections[sections.length - 1].trim() === '') {
                    sections.pop();
                }
                return sections;
            } else {
                return plainTextEditor.value.split(/\n\s*\n/);
            }
        }

        function autoResizeTextarea(event) {
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function maybeAddNewBubble(event) {
            const textarea = event.target;
            const container = textarea.closest('.bubble-container');
            if (container === lyricsEditorContainer.lastElementChild && textarea.value.trim() !== '') {
                lyricsEditorContainer.appendChild(createBubbleElement(''));
            }
        }

        function handleTabText(event) {
            if (event.key === 'Tab') {
                event.preventDefault();
                const textareas = Array.from(lyricsEditorContainer.querySelectorAll('textarea'));
                const currentIndex = textareas.indexOf(event.target);
                const nextIndex = (currentIndex + 1) % textareas.length;
                textareas[nextIndex].focus();
            }
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.bubble-container:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- Section Color System ---
        // Function to extract section ID from a line like "[Verse]" or "[Chorus: Something]"
        function extractSectionId(line) {
            const trimmed = line.trim();
            if (trimmed.startsWith('[') && trimmed.includes(']')) {
                const content = trimmed.substring(1, trimmed.indexOf(']'));
                return content.split(':')[0].trim().toLowerCase();
            }
            return null;
        }

        // Function to get predefined sections with current colors from settings
        function getPredefinedSections() {
            return {
                'verse': { color: settings.sectionColors.verse, name: 'Verse' },
                'chorus': { color: settings.sectionColors.chorus, name: 'Chorus' },
                'bridge': { color: settings.sectionColors.bridge, name: 'Bridge' },
                'pre-chorus': { color: settings.sectionColors.preChorus, name: 'Pre-Chorus' },
                'prechorus': { color: settings.sectionColors.preChorus, name: 'Pre-Chorus' },
                'intro': { color: settings.sectionColors.intro, name: 'Intro' },
                'outro': { color: settings.sectionColors.outro, name: 'Outro' },
                'hook': { color: settings.sectionColors.hook, name: 'Hook' },
                'refrain': { color: settings.sectionColors.refrain, name: 'Refrain' },
                'breakdown': { color: settings.sectionColors.breakdown, name: 'Breakdown' },
                'solo': { color: settings.sectionColors.solo, name: 'Solo' },
                'interlude': { color: settings.sectionColors.interlude, name: 'Interlude' },
                'tag': { color: settings.sectionColors.tag, name: 'Tag' }
            };
        }

        const FALLBACK_COLORS = [
            '#AD1457', '#8E24AA', '#5E35B1', '#3949AB', '#1E88E5', 
            '#039BE5', '#00ACC1', '#00897B', '#43A047', '#689F38', 
            '#827717', '#F57F17', '#FF8F00', '#F57C00', '#FF5722'
        ];

        function getSectionColor(sectionId) {
            const normalizedId = sectionId.toLowerCase().trim();
            const predefinedSections = getPredefinedSections();
            
            // Check if it's a predefined section
            if (predefinedSections[normalizedId]) {
                return predefinedSections[normalizedId].color;
            }
            
            // For custom sections, use hash-based color assignment with better colors
            let hash = 0;
            for (let i = 0; i < normalizedId.length; i++) {
                hash = normalizedId.charCodeAt(i) + ((hash << 5) - hash);
            }
            return FALLBACK_COLORS[Math.abs(hash % FALLBACK_COLORS.length)];
        }

        // --- Bubble Selection Management ---
        function toggleBubbleSelection(container, isMultiSelect = true) {
            const bubbleId = getBubbleId(container);
            const checkbox = container.querySelector('.bubble-checkbox');
            const bubbleElement = container.querySelector('.lyrics-section-bubble');
            
            // Always allow multi-select with checkboxes - only clear if explicitly requested
            if (!isMultiSelect) {
                clearBubbleSelection();
            }
            
            if (selectedBubbles.has(bubbleId)) {
                // Deselect if already selected
                selectedBubbles.delete(bubbleId);
                checkbox.classList.remove('checked');
                bubbleElement.classList.remove('selected');
            } else {
                // Select the bubble
                selectedBubbles.add(bubbleId);
                checkbox.classList.add('checked');
                bubbleElement.classList.add('selected');
            }
            
            updateSelectionCounter();
        }

        function clearBubbleSelection() {
            selectedBubbles.clear();
            document.querySelectorAll('.bubble-checkbox.checked').forEach(checkbox => {
                checkbox.classList.remove('checked');
            });
            document.querySelectorAll('.lyrics-section-bubble.selected').forEach(bubble => {
                bubble.classList.remove('selected');
            });
            updateSelectionCounter();
        }

        function getBubbleId(container) {
            // Use the container's position in the editor as ID
            const containers = Array.from(lyricsEditorContainer.children);
            return containers.indexOf(container);
        }

        function getSelectedBubbles() {
            const containers = Array.from(lyricsEditorContainer.children);
            return Array.from(selectedBubbles).map(id => containers[id]).filter(Boolean);
        }

        function updateSelectionCounter() {
            const count = selectedBubbles.size;
            
            if (count > 0) {
                selectionCountText.textContent = `${count} bubble${count > 1 ? 's' : ''} selected`;
                bubbleSelectionCount.classList.add('visible');
            } else {
                bubbleSelectionCount.classList.remove('visible');
            }
        }

        function copyBubble(container) {
            const textarea = container.querySelector('textarea');
            if (textarea) {
                navigator.clipboard.writeText(textarea.value).then(() => {
                    showSaveStatus('Bubble copied to clipboard!');
                }).catch(() => {
                    // Fallback for older browsers
                    const tempTextarea = document.createElement('textarea');
                    tempTextarea.value = textarea.value;
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();
                    try {
                        document.execCommand('copy');
                        showSaveStatus('Bubble copied to clipboard!');
                    } catch (err) {
                        showSaveStatus('Failed to copy bubble');
                    }
                    document.body.removeChild(tempTextarea);
                });
            }
        }

        function deleteBubble(container) {
            if (confirm('Are you sure you want to delete this bubble?')) {
                const bubbleId = getBubbleId(container);
                selectedBubbles.delete(bubbleId);
                
                // Clean up suggestions dropdown from body
                if (container.suggestionsDropdown) {
                    container.suggestionsDropdown.remove();
                }
                
                container.remove();
                isDirty = true;
                updateSelectionCounter();
                showSaveStatus('Bubble deleted');
            }
        }

        function copySelectedBubbles() {
            const containers = getSelectedBubbles();
            if (containers.length === 0) return;
            
            const content = containers.map(container => {
                const textarea = container.querySelector('textarea');
                return textarea ? textarea.value : '';
            }).filter(text => text.trim()).join('\n\n');
            
            navigator.clipboard.writeText(content).then(() => {
                showSaveStatus(`${containers.length} bubble${containers.length > 1 ? 's' : ''} copied to clipboard!`);
            }).catch(() => {
                // Fallback for older browsers
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = content;
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                try {
                    document.execCommand('copy');
                    showSaveStatus(`${containers.length} bubble${containers.length > 1 ? 's' : ''} copied to clipboard!`);
                } catch (err) {
                    showSaveStatus('Failed to copy bubbles');
                }
                document.body.removeChild(tempTextarea);
            });
        }

        function deleteSelectedBubbles() {
            const containers = getSelectedBubbles();
            if (containers.length === 0) return;
            
            if (confirm(`Are you sure you want to delete ${containers.length} selected bubble${containers.length > 1 ? 's' : ''}?`)) {
                containers.forEach(container => {
                    // Clean up suggestions dropdown from body
                    if (container.suggestionsDropdown) {
                        container.suggestionsDropdown.remove();
                    }
                    container.remove();
                });
                selectedBubbles.clear();
                isDirty = true;
                updateSelectionCounter();
                showSaveStatus(`${containers.length} bubble${containers.length > 1 ? 's' : ''} deleted`);
            }
        }

        function selectAllBubbles() {
            clearBubbleSelection();
            const containers = Array.from(lyricsEditorContainer.children);
            containers.forEach((container, index) => {
                if (container.classList.contains('bubble-container')) {
                    selectedBubbles.add(index);
                    const checkbox = container.querySelector('.bubble-checkbox');
                    const bubbleElement = container.querySelector('.lyrics-section-bubble');
                    if (checkbox) checkbox.classList.add('checked');
                    if (bubbleElement) bubbleElement.classList.add('selected');
                }
            });
            updateSelectionCounter();
        }

        function getSectionSuggestions(currentText) {
            const input = currentText.toLowerCase().trim();
            
            // If already typing a section tag
            if (input.startsWith('[') && !input.endsWith(']')) {
                const partial = input.slice(1).toLowerCase();
                const suggestions = [];
                
                // Add predefined sections that match
                const predefinedSections = getPredefinedSections();
                Object.entries(predefinedSections).forEach(([key, value]) => {
                    // Match if key starts with partial, contains partial, or name contains partial
                    if (key.toLowerCase().startsWith(partial) || 
                        key.toLowerCase().includes(partial) || 
                        value.name.toLowerCase().includes(partial)) {
                        // Avoid duplicates (for pre-chorus/prechorus)
                        if (!suggestions.find(s => s.display === `[${value.name}]`)) {
                            suggestions.push({
                                id: key,
                                name: value.name,
                                display: `[${value.name}]`,
                                color: value.color
                            });
                        }
                    }
                });
                
                // Sort suggestions by relevance (exact matches first, then partial)
                suggestions.sort((a, b) => {
                    const aExact = a.id.toLowerCase().startsWith(partial);
                    const bExact = b.id.toLowerCase().startsWith(partial);
                    if (aExact && !bExact) return -1;
                    if (!aExact && bExact) return 1;
                    return a.name.localeCompare(b.name);
                });
                
                return suggestions.slice(0, 6); // Limit to 6 suggestions
            }
            
            return [];
        }

        function showSectionSuggestions(textarea, dropdown) {
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const lines = textBefore.split('\n');
            const currentLine = lines[lines.length - 1];
            
            const suggestions = getSectionSuggestions(currentLine);
            
            if (suggestions.length > 0) {
                dropdown.innerHTML = suggestions.map((suggestion, index) => `
                    <div class="suggestion-item p-2 hover:bg-gray-700 cursor-pointer flex items-center gap-2 ${index === 0 ? 'bg-gray-700' : ''}" 
                         data-suggestion="${suggestion.display}" data-index="${index}">
                        <div class="w-3 h-3 rounded" style="background-color: ${suggestion.color}"></div>
                        <span class="text-white text-sm">${suggestion.display}</span>
                    </div>
                `).join('');
                
                // Position dropdown using fixed positioning relative to viewport
                const rect = textarea.getBoundingClientRect();
                dropdown.style.top = `${rect.bottom + 5}px`;
                dropdown.style.left = `${rect.left}px`;
                dropdown.classList.remove('hidden');
                
                // Add click handlers
                dropdown.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', () => {
                        applySuggestion(textarea, item.dataset.suggestion);
                        dropdown.classList.add('hidden');
                    });
                });
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function applySuggestion(textarea, suggestion) {
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);
            const lines = textBefore.split('\n');
            const currentLine = lines[lines.length - 1];
            
            // Find the start of the tag being typed
            const tagStart = currentLine.lastIndexOf('[');
            if (tagStart === -1) return;
            
            // Replace from the '[' to the cursor position with the suggestion
            const beforeTag = currentLine.substring(0, tagStart);
            const afterCursor = textAfter;
            const beforeLines = lines.slice(0, -1);
            
            const newLine = beforeTag + suggestion;
            const newText = [...beforeLines, newLine].join('\n') + afterCursor;
            
            textarea.value = newText;
            
            // Position cursor after the suggestion
            const newCursorPos = beforeLines.join('\n').length + (beforeLines.length > 0 ? 1 : 0) + newLine.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            
            // Trigger events to update bubble styling
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            textarea.focus();
        }

        function handleSuggestionKeyboard(e, textarea, dropdown) {
            if (dropdown.classList.contains('hidden')) return false;
            
            const items = dropdown.querySelectorAll('.suggestion-item');
            if (items.length === 0) return false;
            
            const currentSelected = dropdown.querySelector('.suggestion-item.bg-gray-700');
            let selectedIndex = currentSelected ? parseInt(currentSelected.dataset.index) : 0;
            
            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedIndex = (selectedIndex + 1) % items.length;
                    updateSuggestionSelection(items, selectedIndex);
                    return true;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    selectedIndex = selectedIndex === 0 ? items.length - 1 : selectedIndex - 1;
                    updateSuggestionSelection(items, selectedIndex);
                    return true;
                    
                case 'Enter':
                case 'Tab':
                    e.preventDefault();
                    const selectedItem = items[selectedIndex];
                    if (selectedItem) {
                        applySuggestion(textarea, selectedItem.dataset.suggestion);
                        dropdown.classList.add('hidden');
                    }
                    return true;
                    
                case 'Escape':
                    e.preventDefault();
                    dropdown.classList.add('hidden');
                    return true;
            }
            
            return false;
        }

        function updateSuggestionSelection(items, selectedIndex) {
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('bg-gray-700');
                } else {
                    item.classList.remove('bg-gray-700');
                }
            });
        }

        // --- Versioning and Saving ---
        async function saveDraft(isManual = false) {
            if (!isDirty && !isManual) return; // Don't auto-save if no changes

            const song = allSongs[currentSongKey];
            const latestVersion = song.versions[song.versions.length - 1];

            const [mainVersion, draftVersion] = latestVersion.version.split('.');
            const nextDraftNum = draftVersion ? parseInt(draftVersion) + 1 : 1;
            const newVersionString = `${mainVersion}.${nextDraftNum}`;

            const newDraft = {
                version: newVersionString,
                creationDate: new Date().toISOString(),
                lyrics: getLyricsAsArray(),
                style: styleTextarea.value,
                links: allSongs[currentSongKey].versions[allSongs[currentSongKey].versions.length - 1].links || [],
                notes: notesTextarea.value // Use the actual user notes from the textarea
            };

            song.versions.push(newDraft);
            await saveSongToDB(song);
            isDirty = false;

            if (isManual) {
                showSaveStatus("Draft saved!");
                // Only reload song for manual saves to update version picker
                loadSong(currentSongKey, newVersionString);
            } else {
                showSaveStatus(`Auto-saved at ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`);
                // For auto-save, just update the version picker without reloading the whole song
                populateVersionPicker();
                versionDisplay.textContent = formatVersionString(newVersionString);
            }
        }

        async function createVersion() {
            clearInterval(autoSaveInterval);
            const song = allSongs[currentSongKey];
            const latestVersion = song.versions[song.versions.length - 1];
            const mainVersion = parseInt(latestVersion.version.split('.')[0]);
            const newVersionNum = (mainVersion + 1).toString().padStart(5, '0');

            const newVersion = {
                version: newVersionNum,
                creationDate: new Date().toISOString(),
                lyrics: getLyricsAsArray(),
                style: styleTextarea.value,
                links: latestVersion.links || [],
                notes: prompt("Enter notes for this new version:") || ""
            };

            song.versions.push(newVersion);
            await saveSongToDB(song);
            isDirty = false;
            showSaveStatus(`Version ${newVersionNum} created!`);
            loadSong(currentSongKey, newVersionNum);
        }

        function showSaveStatus(message) {
            autoSaveStatus.textContent = message;
            gsap.to(autoSaveStatus, {
                opacity: 1, duration: 0.5, onComplete: () => {
                    gsap.to(autoSaveStatus, { opacity: 0, duration: 0.5, delay: 2 });
                }
            });
        }

        function copyAllLyrics() {
            let lyricsText = '';

            if (currentEditorMode === 'bubbles') {
                // Get lyrics from bubble view - preserve ALL sections and newlines
                const sections = [];
                const textareas = lyricsEditorContainer.querySelectorAll('.lyrics-section-bubble textarea');
                textareas.forEach(textarea => {
                    // Include all sections, even empty ones, to preserve structure
                    sections.push(textarea.value);
                });

                // Remove only the final empty section if it exists (auto-added empty bubble)
                while (sections.length > 0 && sections[sections.length - 1].trim() === '') {
                    sections.pop();
                }

                // Join sections with double newlines to preserve section separation
                lyricsText = sections.join('\n\n');
            } else {
                // Get lyrics from text view
                lyricsText = plainTextEditor.value;
            }

            // Copy to clipboard
            navigator.clipboard.writeText(lyricsText).then(() => {
                showSaveStatus('Lyrics copied to clipboard!');
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = lyricsText;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showSaveStatus('Lyrics copied to clipboard!');
                } catch (err) {
                    showSaveStatus('Failed to copy lyrics');
                }
                document.body.removeChild(textArea);
            });
        }

        function formatVersionString(version) {
            if (version.includes('.')) {
                const parts = version.split('.');
                return `v${parseInt(parts[0])}.${parts[1]}`;
            } else {
                return `v${parseInt(version)}`;
            }
        }

        function populateVersionPicker() {
            const song = allSongs[currentSongKey];
            const latestVersion = song.versions[song.versions.length - 1];
            versionDisplay.textContent = formatVersionString(latestVersion.version);
            versionDropdown.innerHTML = '';

            song.versions.slice().reverse().forEach(v => {
                const item = document.createElement('div');
                item.className = 'version-item border-b border-gray-600 last:border-b-0';
                const date = new Date(v.creationDate || Date.now()).toLocaleString([], {
                    year: 'numeric', month: 'numeric', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', hour12: false
                });
                let versionClass = v.version.includes('.') ? 'draft-version' : 'font-bold';
                const displayVersion = formatVersionString(v.version);

                // Handle auto-saved drafts - show icon instead of text
                let notesDisplay = v.notes || '';
                if (notesDisplay.toLowerCase().includes('auto-saved') || notesDisplay.toLowerCase().includes('auto-save')) {
                    notesDisplay = '<i class="fas fa-floppy-disk text-gray-400 text-sm" title="Auto-saved draft"></i>';
                } else if (notesDisplay) {
                    // Limit notes to 2 lines and add truncation
                    const truncatedNotes = notesDisplay.length > 60 ? notesDisplay.substring(0, 60) + '...' : notesDisplay;
                    notesDisplay = `<span class="text-sm text-gray-300 line-clamp-2 max-w-xs overflow-hidden" title="${notesDisplay}">${truncatedNotes}</span>`;
                }

                // Only show compare button if it's not the current version
                const isCurrentVersion = v.version === latestVersion.version;
                const compareButton = isCurrentVersion ? '' : `
                    <button class="compare-btn text-purple-400 hover:text-purple-300 w-8 h-8 rounded border border-purple-500/30 hover:border-purple-400/50 transition-colors flex items-center justify-center" 
                            data-version="${v.version}" title="Compare with current version">
                        <i class="fas fa-code-compare text-xs"></i>
                    </button>
                `;

                item.innerHTML = `
                    <div class="flex justify-between items-center p-2 hover:bg-gray-700 transition-colors">
                        <div class="flex-1 cursor-pointer version-select" data-version="${v.version}">
                            <div class="flex items-center gap-2">
                                <p class="${versionClass} menu-dropdown-item">${displayVersion}</p>
                                ${notesDisplay}
                            </div>
                            <p class="text-xs text-gray-500 mt-1">${date}</p>
                        </div>
                        <div class="flex gap-2 ml-3">
                            ${compareButton}
                        </div>
                    </div>
                `;

                // Add event listeners
                const versionSelect = item.querySelector('.version-select');
                versionSelect.onclick = () => {
                    versionDropdown.style.display = 'none';
                    if (v.version !== latestVersion.version) {
                        loadSong(currentSongKey, v.version);
                    }
                };

                const compareBtn = item.querySelector('.compare-btn');
                if (compareBtn) {
                    compareBtn.onclick = (e) => {
                        e.stopPropagation();
                        showVersionComparison(latestVersion.version, v.version);
                    };
                }

                versionDropdown.appendChild(item);
            });
        }

        function showVersionComparison(currentVersionStr, compareVersionStr) {
            const song = allSongs[currentSongKey];
            const currentVersion = song.versions.find(v => v.version === currentVersionStr);
            const compareVersion = song.versions.find(v => v.version === compareVersionStr);

            if (!currentVersion || !compareVersion) {
                alert('Error: Could not find version data for comparison');
                return;
            }

            // Create comparison modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-3xl p-8 max-w-7xl w-full max-h-[90vh] overflow-y-auto border border-purple-500/20 shadow-2xl">
                    <div class="flex justify-between items-center mb-8">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center">
                                <i class="fas fa-code-compare text-white text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-3xl font-bold text-white">Version Comparison</h2>
                                <p class="text-gray-400 mt-1">Compare changes between versions</p>
                            </div>
                        </div>
                        <button class="close-modal text-gray-400 hover:text-white p-3 rounded-2xl hover:bg-gray-700/50 transition-all duration-200 group">
                            <i class="fas fa-times text-xl group-hover:rotate-90 transition-transform duration-200"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Current Version -->
                        <div class="bg-gradient-to-br from-purple-900/30 to-purple-800/20 rounded-2xl p-6 border border-purple-500/30">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-8 h-8 bg-purple-500 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-star text-white text-sm"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-purple-300">${formatVersionString(currentVersionStr)}</h3>
                                    <p class="text-sm text-gray-400">Current Version</p>
                                </div>
                            </div>
                            <div class="space-y-6">
                                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                                    <div class="flex items-center gap-2 mb-3">
                                        <i class="fas fa-calendar text-purple-400 text-sm"></i>
                                        <span class="text-sm font-medium text-gray-300">Created</span>
                                    </div>
                                    <p class="text-gray-200">${new Date(currentVersion.creationDate).toLocaleString()}</p>
                                </div>
                                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                                    <div class="flex items-center gap-2 mb-3">
                                        <i class="fas fa-music text-purple-400 text-sm"></i>
                                        <span class="text-sm font-medium text-gray-300">Lyrics</span>
                                    </div>
                                    <div class="bg-slate-900/80 rounded-lg p-4 text-sm text-gray-200 max-h-60 overflow-y-auto border border-slate-600/30 scrollbar-thin">
                                        ${currentVersion.lyrics.join('\\n\\n').replace(/\n/g, '<br>')}
                                    </div>
                                </div>
                                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                                    <div class="flex items-center gap-2 mb-3">
                                        <i class="fas fa-palette text-purple-400 text-sm"></i>
                                        <span class="text-sm font-medium text-gray-300">Style</span>
                                    </div>
                                    <div class="bg-slate-900/80 rounded-lg p-4 text-sm text-gray-200 border border-slate-600/30">
                                        ${currentVersion.style || '<span class="text-gray-500 italic">No style description</span>'}
                                    </div>
                                </div>
                                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                                    <div class="flex items-center gap-2 mb-3">
                                        <i class="fas fa-sticky-note text-purple-400 text-sm"></i>
                                        <span class="text-sm font-medium text-gray-300">Notes</span>
                                    </div>
                                    <div class="bg-slate-900/80 rounded-lg p-4 text-sm text-gray-200 border border-slate-600/30">
                                        ${currentVersion.notes || '<span class="text-gray-500 italic">No notes</span>'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Compare Version -->
                        <div class="bg-gradient-to-br from-emerald-900/30 to-emerald-800/20 rounded-2xl p-6 border border-emerald-500/30">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-8 h-8 bg-emerald-500 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-history text-white text-sm"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-emerald-300">${formatVersionString(compareVersionStr)}</h3>
                                    <p class="text-sm text-gray-400">Compare Version</p>
                                </div>
                            </div>
                            <div class="space-y-6">
                                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                                    <div class="flex items-center gap-2 mb-3">
                                        <i class="fas fa-calendar text-emerald-400 text-sm"></i>
                                        <span class="text-sm font-medium text-gray-300">Created</span>
                                    </div>
                                    <p class="text-gray-200">${new Date(compareVersion.creationDate).toLocaleString()}</p>
                                </div>
                                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                                    <div class="flex items-center gap-2 mb-3">
                                        <i class="fas fa-music text-emerald-400 text-sm"></i>
                                        <span class="text-sm font-medium text-gray-300">Lyrics</span>
                                    </div>
                                    <div class="bg-slate-900/80 rounded-lg p-4 text-sm text-gray-200 max-h-60 overflow-y-auto border border-slate-600/30 scrollbar-thin">
                                        ${compareVersion.lyrics.join('\\n\\n').replace(/\n/g, '<br>')}
                                    </div>
                                </div>
                                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                                    <div class="flex items-center gap-2 mb-3">
                                        <i class="fas fa-palette text-emerald-400 text-sm"></i>
                                        <span class="text-sm font-medium text-gray-300">Style</span>
                                    </div>
                                    <div class="bg-slate-900/80 rounded-lg p-4 text-sm text-gray-200 border border-slate-600/30">
                                        ${compareVersion.style || '<span class="text-gray-500 italic">No style description</span>'}
                                    </div>
                                </div>
                                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                                    <div class="flex items-center gap-2 mb-3">
                                        <i class="fas fa-sticky-note text-emerald-400 text-sm"></i>
                                        <span class="text-sm font-medium text-gray-300">Notes</span>
                                    </div>
                                    <div class="bg-slate-900/80 rounded-lg p-4 text-sm text-gray-200 border border-slate-600/30">
                                        ${compareVersion.notes || '<span class="text-gray-500 italic">No notes</span>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-center gap-6 mt-8 pt-6 border-t border-slate-700/50">
                        <button class="load-version group bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-500 hover:to-emerald-600 text-white px-8 py-4 rounded-2xl font-semibold transition-all duration-200 shadow-lg hover:shadow-emerald-500/25 hover:scale-105 flex items-center gap-3" 
                                data-version="${compareVersionStr}">
                            <i class="fas fa-download group-hover:translate-y-[-2px] transition-transform duration-200"></i>
                            Load ${formatVersionString(compareVersionStr)}
                        </button>
                        <button class="close-modal group bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-500 hover:to-slate-600 text-white px-8 py-4 rounded-2xl font-semibold transition-all duration-200 shadow-lg hover:shadow-slate-500/25 hover:scale-105 flex items-center gap-3">
                            <i class="fas fa-times group-hover:rotate-90 transition-transform duration-200"></i>
                            Close
                        </button>
                    </div>
                </div>
            `;

            // Add event listeners
            modal.querySelector('.close-modal').onclick = () => {
                modal.remove();
            };

            modal.querySelector('.load-version').onclick = () => {
                modal.remove();
                versionDropdown.style.display = 'none';
                loadSong(currentSongKey, compareVersionStr);
            };

            // Close on backdrop click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };

            document.body.appendChild(modal);
        }

        function exportCurrentSong() {
            if (!currentSongKey) return;
            const songData = allSongs[currentSongKey];
            const fileName = `backup/${songData.songKey}.json`;
            const fileContent = JSON.stringify(songData, null, 2);

            const a = document.createElement("a");
            const file = new Blob([fileContent], { type: 'application/json' });
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(a.href);
            showSaveStatus(`Song exported: ${songData.songName}`);
        }

        async function deleteCurrentSong() {
            if (!currentSongKey) return;

            const songData = allSongs[currentSongKey];
            const confirmMessage = `Are you sure you want to delete "${songData.songName}"?\n\nThis action cannot be undone and will delete all versions of this song.`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // Remove from database
                await deleteSongFromDB(currentSongKey);

                // Remove from memory
                delete allSongs[currentSongKey];

                // Clear auto-save interval
                clearInterval(autoSaveInterval);

                // Show success message and return to jukebox
                showSaveStatus("Song deleted successfully!");

                // Small delay to show the message before transitioning
                setTimeout(() => {
                    showJukeboxView();
                }, 1000);

            } catch (error) {
                alert("Error deleting song: " + error);
            }
        }

        async function deleteSongFromJukebox(songKey) {
            if (!songKey || !allSongs[songKey]) return;

            const songData = allSongs[songKey];
            const confirmMessage = `Are you sure you want to delete "${songData.songName}"?\n\nThis action cannot be undone and will delete all versions of this song.`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // Remove from database
                await deleteSongFromDB(songKey);

                // Remove from memory
                delete allSongs[songKey];

                // Re-render the jukebox to remove the deleted song
                renderJukebox();

                // Show success message
                const tempStatus = document.createElement('div');
                tempStatus.className = 'fixed top-20 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-30';
                tempStatus.textContent = 'Song deleted successfully!';
                document.body.appendChild(tempStatus);

                // Remove the message after 3 seconds
                setTimeout(() => {
                    tempStatus.remove();
                }, 3000);

            } catch (error) {
                alert("Error deleting song: " + error);
            }
        }

        // --- Other Helpers ---
        function renderLinks(links) {
            linksList.innerHTML = '';
            if (!links || links.length === 0) {
                linksList.innerHTML = `<p class="text-gray-500">No links added.</p>`;
                return;
            }
            links.forEach((link, index) => {
                const linkEl = document.createElement('div');
                linkEl.className = 'flex justify-between items-center glass-input p-3 rounded-xl mb-3 border border-purple-500/20 hover:border-purple-400/40 transition-all duration-200';
                linkEl.innerHTML = `<a href="${link}" target="_blank" class="text-purple-400 hover:text-purple-300 underline truncate transition-colors duration-200">${link}</a><button data-index="${index}" class="remove-link-btn text-red-400 hover:text-red-300 font-bold text-xl transition-colors duration-200">&times;</button>`;
                linksList.appendChild(linkEl);
            });
            document.querySelectorAll('.remove-link-btn').forEach(btn => btn.addEventListener('click', (e) => removeLink(e.target.dataset.index)));
        }
        function addLink() {
            const newLink = newLinkInput.value.trim();
            if (newLink) {
                isDirty = true;
                const song = allSongs[currentSongKey];
                const latestVersion = song.versions[song.versions.length - 1];
                if (!latestVersion.links) latestVersion.links = [];
                latestVersion.links.push(newLink);
                renderLinks(latestVersion.links);
                newLinkInput.value = ''; // Clear the input field
            }
        }
        function removeLink(index) {
            isDirty = true;
            const song = allSongs[currentSongKey];
            const latestVersion = song.versions[song.versions.length - 1];
            latestVersion.links.splice(index, 1);
            renderLinks(latestVersion.links);
        }
    </script>
</body>

</html>